<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>TomTom JavaScript SDK - Map</title>
		<link rel="stylesheet" type="text/css" href="../../css/map.css" />
		<script src="http://ajax.googleapis.com/ajax/libs/dojo/1.8.0/dojo/dojo.js"></script>
        <script type="text/javascript" src="../../js/OpenLayers-2.12.min.js"></script>
        <script type="text/javascript" src="../../js/dojo/tomtom.map.js"></script>
        <script type="text/javascript" src="../../js/dojo/tomtom.controls.js"></script>
        <script type="text/javascript" src="../addresses.js"></script>
        <script type="text/javascript" src="../apikey.js"></script>
        <script>
        	require(["dojo/ready"], function(ready) {
        		
        		ready(function() {
        		
	        		tomtom.setImagePath("../../images/");
	        		
	        		function showAddress(e) {
						var lonlat = map.getLonLatFromPixel({ x: e.x, y: e.y });
	        			
	        			// reverse geocode
	        			var geocoder = new tomtom.services.GeocodingService();
	        			
	        			// since the lonlat returned is in EPSG 900913, and also adding the popup needs to be done in EPSG 900913
	        			// specify EPSG 900913 as the projection
	        			geocoder.reverseGeocode(lonlat.lon, lonlat.lat, { projection: "EPSG900913" }, function(response) {
	        				
	        				var content = "No address found.";
	        				
	        				if (response && response.reverseGeoResponse 
	        						&& response.reverseGeoResponse.reverseGeoResult 
	        						&& response.reverseGeoResponse.reverseGeoResult.formattedAddress)
	        					content = response.reverseGeoResponse.reverseGeoResult.formattedAddress;
	        				
							var popup = new tomtom.Popup({ lonlat: lonlat, contentHTML: content });
							map.addPopup(popup);
							popup.show();
	        				
	        			});
	        		}
	        		
	        		function removeMarker(e) {
	        			
	        			manager.removeMarker(e.targetObject);
	        			manager.update();
	        			
	        		}
	        		
	        		var map = new tomtom.Map({
	        			domNode: "map",
	        			cookie: true,
	        			scale: true
	        		});
	        		
	        		var contextMenu = new tomtom.controls.ContextMenu({
	       				menuItems: [
	       						{ label: "Help", onClick: function() { alert("HELP!"); } },
	       						{ label: "Lookup Address", onClick: showAddress }
	       					]
	               		});
	        		
	        		contextMenu.events.register("menuitemclick", window, function(e) {
	        			if (console)
	        				console.log(e.x, e.y, e.menuItem);
	        		});
	        		
	        		map.setContextMenu(contextMenu);
	        		
	        		var manager = new tomtom.MarkerManager({ map: map, animation: { effect: "drop", delay: 120, duration: 1000 } });
	        		
	        		map.events.register("mapload", window, function() {
	        			
	        			var markerContextMenu = new tomtom.controls.ContextMenu({
	        				menuItems: [
	      						{ label: "Marker Help", onClick: function() { alert("MARKER HELP!"); } },
	      						{ label: "Remove", onClick: removeMarker }
	      					]
	              		});
		        		
		        		marker = new tomtom.Marker(-104.98485, 39.73845);
	        			marker.setContextMenu(markerContextMenu);
		        		manager.addMarker(marker);
		        		
		        		marker = new tomtom.Marker(-118.24334, 34.05224);
	        			marker.setContextMenu(markerContextMenu);
		        		manager.addMarker(marker);
		        		
		        		marker = new tomtom.Marker(-122.42017, 37.78008);
	        			marker.setContextMenu(markerContextMenu);
		        		manager.addMarker(marker);
		        		
		        		manager.update();
	        		});
	        		
        		});
        		
        	});
        </script>
        <style type="text/css">
        	html, body {
        		width: 100%;
        		height: 100%;
        		margin: 0;
        		padding: 0;
        	}
        </style>
	</head>
	<body>
		<div style="width: 100%; height: 100%;" id="map"></div>
	</body>
</html>