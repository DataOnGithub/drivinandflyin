<!DOCTYPE HTML>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link href='https://fonts.googleapis.com/css?family=Arimo:400,700,400italic|Oxygen' rel='stylesheet' type='text/css'>
<link href='https://fonts.googleapis.com/css?family=Inconsolata:400,700' rel='stylesheet' type='text/css'>
<link rel="apple-touch-icon-precomposed" href="somepath/image.png" />
<link rel="StyleSheet" href="https://www.airmanopus.net/weathercheck/iphone.css" type="text/css">

<script src='https://api.tiles.mapbox.com/mapbox.js/v1.6.4/mapbox.js'></script>
<link href='https://api.tiles.mapbox.com/mapbox.js/v1.6.4/mapbox.css' rel='stylesheet' />
<script src='https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-osm/v0.1.0/leaflet-osm.js'></script>
<script type="text/javascript">  
	// CSVToArray (c) ben nadel
        // http://www.bennadel.com/blog/1504-ask-ben-parsing-csv-strings-with-javascript-exec-regular-expression-command.htm
        //
        // This will parse a delimited string into an array of
        // arrays. The default delimiter is the comma, but this
        // can be overriden in the second argument.
        function CSVToArray( strData, strDelimiter ){
        // Check to see if the delimiter is defined. If not,
        // then default to comma.
        strDelimiter = (strDelimiter || ",");

        // Create a regular expression to parse the CSV values.
        var objPattern = new RegExp(
        (
        // Delimiters.
        "(\\" + strDelimiter + "|\\r?\\n|\\r|^)" +

        // Quoted fields.
        "(?:\"([^\"]*(?:\"\"[^\"]*)*)\"|" +

        // Standard fields.
        "([^\"\\" + strDelimiter + "\\r\\n]*))"
        ),
        "gi"
        );


        // Create an array to hold our data. Give the array
        // a default empty first row.
        var arrData = [[]];

        // Create an array to hold our individual pattern
        // matching groups.
        var arrMatches = null;


        // Keep looping over the regular expression matches
        // until we can no longer find a match.
        while (arrMatches = objPattern.exec( strData )){

        // Get the delimiter that was found.
        var strMatchedDelimiter = arrMatches[ 1 ];

        // Check to see if the given delimiter has a length
        // (is not the start of string) and if it matches
        // field delimiter. If id does not, then we know
        // that this delimiter is a row delimiter.
        if (
        strMatchedDelimiter.length &&
        (strMatchedDelimiter != strDelimiter)
        ){

        // Since we have reached a new row of data,
        // add an empty row to our data array.
        arrData.push( [] );

        }


        // Now that we have our delimiter out of the way,
        // let's check to see which kind of value we
        // captured (quoted or unquoted).

   if (arrMatches[ 2 ]){

        // We found a quoted value. When we capture
        // this value, unescape any double quotes.
        var strMatchedValue = arrMatches[ 2 ].replace(
        new RegExp( "\"\"", "g" ),
        "\""
        );

        } else {

        // We found a non-quoted value.
        var strMatchedValue = arrMatches[ 3 ];
         // We found a non-quoted value.
        var strMatchedValue = arrMatches[ 3 ];

        }


        // Now that we have our value string, let's add
        // it to the data array.
        arrData[ arrData.length - 1 ].push( strMatchedValue );
        }

        // Return the parsed data.
        return( arrData );
        }



function geoError() {
        document.write("<span class='errorText'>Geolocation failed. You may need to enable location services on your device.</span>");
}

function updateWeather() {

        // get current weather conditions 
	var weatherLat = arguments[0];
    	var weatherLon = arguments[1];
	console.log("updateWeather",lat,lon);
	var weatherGetURL = "https://api.worldweatheronline.com/free/v1/weather.ashx?q=" + lat + "%2C" + lon + "&format=json&extra=localObsTime%2CisDayTime&num_of_days=1&date=tomorrow&includelocation=yes&key=kc2u593rw3h5bp2pga7fs7ut";
        var weatherGet = new XMLHttpRequest();
        weatherGet.open('GET',weatherGetURL,false);
        weatherGet.send();
	
        var weatherResponse = JSON.parse(weatherGet.responseText);
        console.log("wwo " + weatherGet.statusText);
        var weatherDesc = weatherResponse.data.current_condition[0].weatherDesc[0].value;
        var temp_F = weatherResponse.data.current_condition[0].temp_F;
        var visibility = weatherResponse.data.current_condition[0].visibility;
        var humidity = weatherResponse.data.current_condition[0].humidity;   
        var precipMM = weatherResponse.data.current_condition[0].precipMM;
        var windSpeed = weatherResponse.data.weather[0].windspeedMiles;
        var windDir = weatherResponse.data.weather[0].winddirection;
        var obsTime = weatherResponse.data.current_condition[0].localObsDateTime;
        var city = weatherResponse.data.nearest_area[0].areaName[0].value;
        var state = weatherResponse.data.nearest_area[0].region[0].value;


        // calculate heat index and wind chill
        var tempSquared = temp_F * temp_F;
        var relHSquared = humidity * humidity;
        var heatIndex = Math.round(-42.379 + (2.04901523 * temp_F) + (10.14333127 * humidity) - (0.22475541 * temp_F * humidity) - ( .00683783 * tempSquared) - (.05481717 * relHSquared) + ( .00122874 * tempSquared * humidity) + (.00085282 * temp_F * relHSquared) - (.00000199 * tempSquared * relHSquared));
        var windChill = Math.round(35.74 + (0.6215 * temp_F) - (35.75 * Math.pow(windSpeed,0.16)) + (0.4275 * temp_F * Math.pow(windSpeed,0.16)));

        // TODO re add one line short term forecast 
        
        var weatherIconURL = weatherResponse.data.weather[0].weatherIconURL;
        var weatherInfoURL = weatherResponse.data.weather[0].weatherURL;
        
        localWeather.innerHTML = ""; // clear last observation data
        localWeather.innerHTML += city + ", " + state + "<br>";
        localWeather.innerHTML += lat.toPrecision(9) + "," + lon.toPrecision(9) + "<br>";
        localWeather.innerHTML += weatherDesc + " and " + temp_F + "\xB0" + "F<br>";
	localWeather.innerHTML += "Humidity " + humidity + "% Visibility " + visibility + " mi<br>";
        localWeather.innerHTML += "Wind " + windDir + " at " + windSpeed + "mph<br>";
        if (temp_F < 45){
                getElementById("localWeather").innerHTML += "Wind Chill " + windChill + "\xB0" + "F<br>";
        }
        if (temp_F > 70){
                localWeather.innerHTML += "Heat Index " + heatIndex + "\xB0" + "F<br>";
        }
        localWeather.innerHTML += (precipMM>0.0)?"Precip (mm) "+ precipMM + "<br>":"Precip none<br>";
        localWeather.innerHTML += "Observation time " + obsTime + "<br>";

}


function updateArrivals() {

	var airportIATA = arguments[0];
	var q = new Date();                     // current date to use for requesting flight data for an airport
        var arrivalsyear = q.getFullYear();             // current year
    	var arrivalsmonth = q.getMonth()+1;               // current month
    	var arrivalsday = q.getDate();                   // current day
    	var arrivalshour = q.getHours();
    	const numHourstoInclude = 3;
	var arrivingFlightsGetVerify = true;
	var arrivingFlightsGet = new XMLHttpRequest();
	var arrivingFlightsURL = "https://api.flightstats.com/flex/flightstatus/rest/v2/json/airport/status/" + airportIATA + "/arr/" + arrivalsyear + "/" + arrivalsmonth + "/" + arrivalsday + "/" + arrivalshour + "?appId=03ac1ffa&appKey=0505f46298d4dc8c52468a3338aa7453&utc=false&numHours=5&maxFlights=5&extendedOptions=useInlinedReferences";
	var arrivingFlightsProcess="https://www.airmanopus.net/cgi-bin/arrivals.cgi?" + arrivingFlightsURL;
	arrivingFlightsGet.open('GET', arrivingFlightsProcess, false);
	arrivingFlightsGet.send();
	console.log("arriving flights",arrivingFlightsGet.statusText);

	 try
	 {      
		 var arrivingFlightsJSON = JSON.parse(arrivingFlightsGet.responseText);
	 }

	 catch(err)
	 {
		 document.getElementById("airportsArrivals").innerHTML += "<br<Arrivals<br><br>";
		 document.getElementById("airportsArrivals").innerHTML += "There are no flights scheduled to arrive during the next " + numHourstoInclude + " hours.<br>";
		 arrivingFlightsGetVerify = false;
	 }
	 if (arrivingFlightsGetVerify == true)
	 {
		if (arrivingFlightsJSON.flightStatuses.length > 0)
		{
		console.log(arrivingFlightsJSON);
		document.getElementById("airportsArrivals").innerHTML += "<br>Arrivals<br>";
		var i = 0;
		while ( i < arrivingFlightsJSON.flightStatuses.length ) 
		{
			
			var arrivingFlightStatus = {
			carrierName         		: arrivingFlightsJSON.flightStatuses[i].carrier.name,
			carrierPhone            	: arrivingFlightsJSON.flightStatuses[i].carrier.phoneNumber,
			flightNumber            	: arrivingFlightsJSON.flightStatuses[i].flightNumber,
			carrierIATA             	: arrivingFlightsJSON.flightStatuses[i].carrier.iata,

			departureAirportIATA            : arrivingFlightsJSON.flightStatuses[i].departureAirport.iata,
			departureAirportName            : arrivingFlightsJSON.flightStatuses[i].departureAirport.name,
			departureAirportCity            : arrivingFlightsJSON.flightStatuses[i].departureAirport.city,
			departureAirportState           : arrivingFlightsJSON.flightStatuses[i].departureAirport.stateCode,
			departureAirportTZ              : arrivingFlightsJSON.flightStatuses[i].departureAirport.timeZoneRegionalName,
			departureAirportLocalTime       : arrivingFlightsJSON.flightStatuses[i].departureAirport.localTime,
			departureAirportElevation       : arrivingFlightsJSON.flightStatuses[i].departureAirport.elevationFeet,
			departureDateLocal              : arrivingFlightsJSON.flightStatuses[i].departureDate.dateLocal,
			departureGate			: "",
			departureTerminal		: "",	
			
			arrivalAirportIATA	    	: arrivingFlightsJSON.flightStatuses[i].arrivalAirport.iata,
			arrivalAirportName    		: arrivingFlightsJSON.flightStatuses[i].arrivalAirport.name,
			arrivalAirportCity    		: arrivingFlightsJSON.flightStatuses[i].arrivalAirport.city,
			arrivalAirportState   		: arrivingFlightsJSON.flightStatuses[i].arrivalAirport.stateCode,
			arrivalAirportTZ     	 	: arrivingFlightsJSON.flightStatuses[i].arrivalAirport.timeZoneRegionalName,
			arrivalAirportLocalTime 	: arrivingFlightsJSON.flightStatuses[i].arrivalAirport.localTime,
			arrivalAirportElevation 	: arrivingFlightsJSON.flightStatuses[i].arrivalAirport.elevationFeet,
			arrivalDateLocal              	: arrivingFlightsJSON.flightStatuses[i].arrivalDate.dateLocal,
			arrivalGate			: "",
			arrivalTerminal			: "",

			opPublishedDeparture            : arrivingFlightsJSON.flightStatuses[i].operationalTimes.publishedDeparture.dateLocal,
			opPublishedArrival              : arrivingFlightsJSON.flightStatuses[i].operationalTimes.publishedArrival.dateLocal,                                                                 
			opSchedGateDeparture    	: arrivingFlightsJSON.flightStatuses[i].operationalTimes.scheduledGateDeparture.dateLocal,
			opFlightPlanDeparture           : arrivingFlightsJSON.flightStatuses[i].operationalTimes.flightPlanPlannedDeparture.dateLocal,
			opEstRunwayDeparture            : arrivingFlightsJSON.flightStatuses[i].operationalTimes.estimatedRunwayDeparture.dateLocal,
			opSchedGateArrival              : arrivingFlightsJSON.flightStatuses[i].operationalTimes.scheduledGateArrival.dateLocal,
			opFlightPlanPlannedArrival      : arrivingFlightsJSON.flightStatuses[i].operationalTimes.flightPlanPlannedArrival,
			opEstimatedRunwayArrival        : arrivingFlightsJSON.flightStatuses[i].operationalTimes.estimatedRunwayArrival,
			opFlightPlanPlannedArrival      : arrivingFlightsJSON.flightStatuses[i].operationalTimes.flightPlanPlannedArrival,
			opEstimatedRunwayArrival        : arrivingFlightsJSON.flightStatuses[i].operationalTimes.estimatedRunwayArrival,

			flightEquipIATA                 : arrivingFlightsJSON.flightStatuses[i].flightEquipment.iata,
			flightEquipHardware             : arrivingFlightsJSON.flightStatuses[i].flightEquipment.name,
			flightEquipTurboprop            : arrivingFlightsJSON.flightStatuses[i].flightEquipment.turboProp,
			flightEquipJet                  : arrivingFlightsJSON.flightStatuses[i].flightEquipment.jet,
			flightEquipWidebody             : arrivingFlightsJSON.flightStatuses[i].flightEquipment.widebody,

			status                          : arrivingFlightsJSON.flightStatuses[i].status

			}; // arrivingFlightStatus 
			i++;
			// the departureGate, departureTerminal, and arrivalGate are sometimes not included in the ajax response

	} // while
} // if
} // if			
	

// TODO display each arriving flights information
//	document.getElementById("airportsArrivals").innerHTML += arrivingFlightStatus.carrierName + " " + arrivingFlightStatus.flightNumber + " from " +  arrivingFlightStatus.departureAirportCity + " " + arrivingFlightStatus.departureAirportState + " " +  flightStatusCodes[arrivingFlightStatus.status] + "<br>"; 


	var arrivingPlanesGet = new XMLHttpRequest();
	var arrivingPlanesURL = "https://api.flightstats.com/flex/flightstatus/rest/v2/json/airport/tracks/MSN/arr?appId=03ac1ffa&appKey=0505f46298d4dc8c52468a3338aa7453&includeFlightPlan=false&maxPositions=2&maxPositionAgeMinutes=15&extendedOptions=useInlinedReferences";
	var arrivingPlanesProcess="https://www.airmanopus.net/cgi-bin/arrivals.cgi?" + arrivingPlanesURL;
	arrivingPlanesGet.open('GET',arrivingPlanesProcess,false);
	arrivingPlanesGet.send();
	var arrivingPlaneStatusJSON = JSON.parse(arrivingPlanesGet.responseText);
	console.log(arrivingPlaneStatusJSON.flightTracks);
	
	if (arrivingPlaneStatusJSON.flightTracks.length != 0)
	{	
		var i = 0;
		while ( i < arrivingFlightsJSON.flightStatuses.length )
		{
			var arrivingAirplaneStatus = {
				arrivingFlightID       : arrivingPlaneStatusJSON.flightTracks[i].flightID,
				departingAirport        : arrivinglaneStatusJSON.flightTracks[i].departureAirport.iata,
				arrivingairport         : arrivingPlaneStatusJSON.flightTracks[i].arrivalAirport.iata,
				depAirplaneBearing      : arrivingPlaneStatusJSON.flightTracks[i].bearing,
				depAirplaneHeading      : arrivingPlaneStatusJSON.flightTracks[i].heading,

				arrivingAirplaneLon0   : arrivingPlaneStatusJSON.flightTracks[i].positions[0].lon,
				arrivingAirplaneLat0   : arrivingPlaneStatusJSON.flightTracks[i].positions[0].lat,
				arrivingAirplaneSpeed0 : arrivingPlaneStatusJSON.flightTracks[i].positions[0].speedMPH,
				arrivingAirplaneAlt0   : arrivingPlaneStatusJSON.flightTracks[i].positions[0].altitudeFt,
				arrivingAirplaneSource0 : arrivingPlaneStatusJSON.flightTracks[i].positions[0].source,
				arrivingAirplaneDate0  : arrivingPlaneStatusJSON.flightTracks[i].positions[0].date,

				arrivingAirplaneLon1   : arrivingPlaneStatusJSON.flightTracks[i].positions[1].lon,
				arrivingAirplaneLat1   : arrivingPlaneStatusJSON.flightTracks[i].positions[1].lat,
				arrivingAirplaneSpeed1 : arrivingPlaneStatusJSON.flightTracks[i].positions[1].speedMPH,
				arrivingAirplaneAlt1   : arrivingPlaneStatusJSON.flightTracks[i].positions[1].altitudeFt,
				arrivingAirplaneSource1 : arrivingPlaneStatusJSON.flightTracks[i].positions[1].source,
				arrivingAirplaneDate1  : arrivingPlaneStatusJSON.flightTracks[i].positions[1].date
			}; // arrivingAirplaneStatus

		// display status info line fer this flight	here
		//
			
		i++;
		} // while
	} else {
		airportsArrivals.innerHTML += "No tracks available for arrivals.";	
	}
}	

function updateTraffic()
{

	var lat = arguments[0];
    	var lon = arguments[1];
	var airportLat = arguments[2];
	var airportLon = arguments[3];
	var airportIATA = arguments[4];
	var distance = arguments[5];
	console.log("updateTraffic",arguments);
	// check traffic to get estimate on when will we get to the airport 
	// we always display driving  ETA from our location to each airport
	// TODO we also want to include directions slash routing information
	var airportETAGet = new XMLHttpRequest();
	var airportETAURL="https://api.tomtom.com/lbs/services/route/3/" + lat + "," + lon + ":" + airportLat + "," + airportLon + "/Quickest/json?avoidTraffic=true&includeTraffic=true&day=today&iqRoutes=2&includeInstructions=true&key=knpmsu5p59rxdud2rmghsxd7"
	var airportETAProcess="https://www.airmanopus.net/cgi-bin/tomtom.cgi?" + airportETAURL;
	airportETAGet.open('GET', airportETAProcess, false);
	airportETAGet.send();
	console.log("traffic",airportETAGet.statusText);	
	airportETAParsed=JSON.parse(airportETAGet.responseText);
	airportETA = airportETAParsed.route.summary.arrivalOverview.time;
	if (airportIATA != null)
	{
		document.getElementById("airportsTraffic").innerHTML += "This airport is approx " + distance.toFixed(2) + " miles away. <br> Your estimated arrival time at " + airportIATA + " is " + airportETA + ".<br><br>";
	}	

	// note: airportETA is the time we expect to reach this airport
	var currentTime = new Date();
	var hour = currentTime.getHours();
	var day = currentTime.getDate();
	var month = currentTime.getMonth() + 1;
	var year = currentTime.getFullYear();

	var numHourstoInclude = 3;

	var numHourstoIncludeArrivals = 2; 	// airportETA + 2 hours
	var displayTimeArrivalsStart = airportETA;
	var displayTimeArrivalsEnd = airportETA + "02:00";	
	
	var numHourstoIncludeDepartures = 4; 	// (airportETA - 1 hour) to (airportETA + 3 hours)
	var displayTimeDeparturesStart = airportETA - "01:00";
	var displayTimeDeparturesEnd = airportETA + "03:00";	


}

function updateDelays()
{
	console.log("updateDelays",arguments);
 	var iataIdentifier = arguments[0];
	
// see if this airport has a delay or closure notice posted
	var airportStatusURL="https://www.airmanopus.net/cgi-bin/airports.cgi?iata=" + iataIdentifier;
	var airportStatusGet = new XMLHttpRequest();
	airportStatusGet.open('GET',airportStatusURL,false);
	airportStatusGet.send();
	console.log("airport delays",airportStatusGet.statusText);
	var airportStatusResponse = airportStatusGet.responseText;
	// if we see a less than chr we didnt get a json response so no delays
	// probably a smaller airport that FAA doesnt keep status on
	// we always display the delay text
	if ( airportStatusResponse.charAt(0) != "<" )
	{
		var airportStatus = JSON.parse(airportStatusGet.responseText);
		var airportIATA = airportStatus.IATA;
		var airportName = airportStatus.name;
		var delayStatus = airportStatus.delay;
		var airportDelayReason = airportStatus.status.reason;
		var airportClosureBegin = airportStatus.status.closureBegin;
		var airportClosureEnd = airportStatus.status.closureEnd;
		var airportMinDelay = airportStatus.status.MinDelay;
		var airportMaxDelay = airportStatus.status.MaxDelay;
		var airportAvgDelay = airportStatus.status.AvgDelay;
		
		// add this airport to the map
		//L.marker([airportLat, airportLon]).addTo(map);

		// name and IATA always display if within viewPortdistance 	
		document.getElementById("airportsDelays").innerHTML += "<span class='airportTitle'>";
		document.getElementById("airportsDelays").innerHTML += airportName + " (" + airportIATA + ")<br>";
		document.getElementById("airportsDelays").innerHTML += airportDelayReason + "<br>";
		document.getElementById("airportsDelays").innerHTML += "</span>";
		// display closure info only if airport is closed 
		if ( airportClosureBegin != "")
		{
			 document.getElementById("airportsDelays").innerHTML +=  "<br>Closed from " + airportClosureBegin + " to " + airportClosureEnd;
		} 

		// display delay reason only when there is a delay
		if  (delayStatus != "false")
		{
			// display delay times only if we received them
			if (airportMinDelay != null)
			{
			document.getElementById("airportsDelays").innerHTML += "<br>Min " + airportMinDelay + " Max " + airportMaxDelay + " Avg " + airportAvgDelay;
			}
		}
	} // if
}
function updateDepartures()
{
	console.log("updateDepartures",arguments);
	var airportIATA = arguments[0];
	var d = new Date();			// current date to use for requesting flight data for an airport
	var year = d.getFullYear();		// current year
	var month = d.getMonth() + 1;		// current month
	var day = d.getDate();			// current day
	var hour = d.getHours();		
	const numHourstoInclude = 3;
	var departingFlightsGet = new XMLHttpRequest();
	var departingFlightsURL="https://www.airmanopus.net/cgi-bin/departures.cgi?https://api.flightstats.com/flex/flightstatus/rest/v2/json/airport/status/" + airportIATA + "/dep/" + year + "/" + month + "/" + day + "/" + hour + "?appId=03ac1ffa&appKey=0505f46298d4dc8c52468a3338aa7453&utc=false&numHours=" + numHourstoInclude + "&extendedOptions=useInlinedReferences";
	var departingFlightsGetVerify = true;
	departingFlightsGet.open('GET', departingFlightsURL, false);
	departingFlightsGet.send();
	console.log("departing flights",departingFlightsGet.statusText);
	try
	{	
		// if there are no departing flights to get, we receive a 404 error here
		var departingFlightsJSON = JSON.parse(departingFlightsGet.responseText);
	}

	catch(err) 
	{
		// display message indicating no departing flights and carry on
		document.getElementById("airportsDepartures").innerHTML += "There are no flights scheduled to depart during the next " + numHourstoInclude + " hours.<br>";
		departingFlightsGetVerify = false;
	}
	
	if (departingFlightsGetVerify == true)
	{
		// display information for each departing flight from this particular airport
		if (departingFlightsJSON.flightStatuses.length > 0)
		{
			document.getElementById("airportsDepartures").innerHTML += "Departures<br><br>";
			for ( k = 0; k < departingFlightsJSON.flightStatuses.length; k++ )
			{ 
				var departingFlightStatus = {
					carrierIATA			: departingFlightsJSON.flightStatuses[k].carrier.iata,
					carrierName			: departingFlightsJSON.flightStatuses[k].carrier.name,
					carrierPhoneNumber		: departingFlightsJSON.flightStatuses[k].carrier.phoneNumber,
		
					departureAirportIATA		: departingFlightsJSON.flightStatuses[k].departureAirport.iata,
					departureAirportName		: departingFlightsJSON.flightStatuses[k].departureAirport.name,
					departureAirportCity		: departingFlightsJSON.flightStatuses[k].departureAirport.city,
					departureAirportState		: departingFlightsJSON.flightStatuses[k].departureAirport.stateCode,
					departureAirportTZ		: departingFlightsJSON.flightStatuses[k].departureAirport.timeZoneRegionalName,
					departureAirportLocalTime	: departingFlightsJSON.flightStatuses[k].departureAirport.localTime,
					departureAirportElevation 	: departingFlightsJSON.flightStatuses[k].departureAirport.elevationFeet,	
					//departureDateLocal		: departingFlightsJSON.flightStatuses[k].departureDate.dateLocal,

					arrivalAirportIATA		: departingFlightsJSON.flightStatuses[k].arrivalAirport.iata,
					arrivalAirportName 		: departingFlightsJSON.flightStatuses[k].arrivalAirport.name,
					arrivalAirportCity		: departingFlightsJSON.flightStatuses[k].arrivalAirport.city,
					arrivalAirportState		: departingFlightsJSON.flightStatuses[k].arrivalAirport.stateCode,
					arrivalAirportTZ		: departingFlightsJSON.flightStatuses[k].arrivalAirport.timeZoneRegionalName,
					arrivalAirportLocalTime		: departingFlightsJSON.flightStatuses[k].arrivalAirport.localtime,
					arrivalAirportElevation		: departingFlightsJSON.flightStatuses[k].arrivalAirport.elevationFeet,
					// arrivalDateLocal		: departingFlightsJSON.flightStatuses[k].arrivalDate.dateLocal,
	
					//	opPublishedDeparture		: departingFlightsJSON.flightStatuses[k].operationalTimes.publishedDeparture.dateLocal,
					//	opPublishedArrival		: departingFlightsJSON.flightStatuses[k].operationalTimes.publishedArrival.dateLocal,
					//	opSchedGateDeparture		: departingFlightsJSON.flightStatuses[k].operationalTimes.scheduledGateDeparture.dateLocal,
					//	opFlightPlanDeparture		: departingFlightsJSON.flightStatuses[k].operationalTimes.flightPlanPlannedDeparture.dateLocal,	
					//	opEstRunwayDeparture		: departingFlightsJSON.flightStatuses[k].operationalTimes.estimatedRunwayDeparture.dateLocal,
					//	opSchedGateArrival		: departingFlightsJSON.flightStatuses[k].operationalTimes.scheduledGateArrival.dateLocal,
					opFlightPlanPlannedArrival	: departingFlightsJSON.flightStatuses[k].operationalTimes.flightPlanPlannedArrival,
					opEstimatedRunwayArrival	: departingFlightsJSON.flightStatuses[k].operationalTimes.estimatedRunwayArrival,
					opFlightPlanPlannedArrival	: departingFlightsJSON.flightStatuses[k].operationalTimes.flightPlanPlannedArrival,
					opEstimatedRunwayArrival	: departingFlightsJSON.flightStatuses[k].operationalTimes.estimatedRunwayArrival,
					
					//			flightEquipIATA			: departingFlightsJSON.flightStatuses[k].flightEquipment.iata,
					//			flightEquipHardware		: departingFlightsJSON.flightStatuses[k].flightEquipment.name,
					//			flightEquipTurboprop		: departingFlightsJSON.flightStatuses[k].flightEquipment.turboProp,
					//			flightEquipJet			: departingFlightsJSON.flightStatuses[k].flightEquipment.jet,
					//			flightEquipWidebody		: departingFlightsJSON.flightStatuses[k].flightEquipment.widebody,	
					
					status				: departingFlightsJSON.flightStatuses[k].status,
					
					//				departureGate			: departingFlightsJSON.flightStatuses[k].airportResources.departureGate,
					//				arrivalTerminal			: departingFlightsJSON.flightStatuses[k].airportResources.arrivalTerminal,
					//				arrivalGate			: departingFlightsJSON.flightStatuses[k].airportResources.arrivalGate
				}; // departingFlightStatus
				// TODO add info on codeshares
				// flightStatuses[].codeshares[].carrier, .iata, .name, .phoneNumber.flightNumber
			} // k
			
			// TODO now we get to display information about the flight described by departingFlightStatus
			// fields (for now)
			document.getElementByID("airportsDepartures").innerHTML += "Flight ____ " + departingFlightStatus.carrierName + " " + " " +  departingFlightStatus.departureAirportCity + " " +  departingFlightStatus.departureAirportState + "(Elev. " +  departingFlightStatus.arrivalAirportElevation + ")<br>" + flightStatusCodes[status] + " Departs " +  departingFlightStatus.departureGate + " Arrives " +  departingFlightStatus.arrivalTerminal + " Gate " +  departingFlightStatus.arrivalGate;

			// TODO end of displaying information about the flight described by departingFlightStatus 
				
			// flight track information for a specific flight that is departing from an airport we are tracking
			// and is within the radius of the area we are tracking and is on our list of departures 
			// (The MD80 I am riding is headed WSW at 350MPH at an altitude of 35000 feet, at specific lat/lon)
			// a track is a line vector drawn between the most recent two reported positions on a map
			var departingPlaneStatusGet = new XMLHttpRequest();
			var departingPlaneStatusURL="https://api.flightstats.com/flex/flightstatus/rest/v2/json/airport/tracks/" + airportIATA + "/arr?appId=03ac1ffa&appKey=0505f46298d4dc8c52468a3338aa7453&includeFlightPlan=false&maxPositions=2&maxPositionAgeMinutes=15&extendedOptions=useInlinedReferences";
			var departingPlaneStatusProcess = "https://www.airmanopus.net/cgi-bin/departures.cgi?" + departingPlaneStatusURL;
			departingPlaneStatusGet.open('GET', departingPlaneStatusProcess, false);
			departingPlaneStatusGet.send();
			console.log("departing planes",departingPlanesStatusGet.responseText);
			var departingPlaneStatusJSON = JSON.parse(departingPlaneStatusGet.responseText);
			var j = 0;
			while ( j < departingPlaneStatusJSON.flightTracks.length )
			{
				var departingAirplaneStatus = {
					departingFlightID 	: departingPlaneStatusJSON.flightTracks[j].flightID,
					departingAirport 	: departingPlaneStatusJSON.flightTracks[j].departureAirport.iata,
					arrivingairport 	: departingPlaneStatusJSON.flightTracks[j].arrivalAirport.iata,
					depAirplaneBearing	: departingPlaneStatusJSON.flightTracks[j].bearing,
					depAirplaneHeading	: departingPlaneStatusJSON.flightTracks[j].heading,

					departingAirplaneLon0	: departingPlaneStatusJSON.flightTracks[j].positions[0].lon,			
					departingAirplaneLat0	: departingPlaneStatusJSON.flightTracks[j].positions[0].lat,
					departingAirplaneSpeed0	: departingPlaneStatusJSON.flightTracks[j].positions[0].speedMPH,
					departingAirplaneAlt0	: departingPlaneStatusJSON.flightTracks[j].positions[0].altitudeFt,
					departingAirplaneSource0 : departingPlaneStatusJSON.flightTracks[j].positions[0].source,
					departingAirplaneDate0	: departingPlaneStatusJSON.flightTracks[j].positions[0].date,
					
					departingAirplaneLon1   : departingPlaneStatusJSON.flightTracks[j].positions[1].lon,
					departingAirplaneLat1   : departingPlaneStatusJSON.flightTracks[j].positions[1].lat,
					departingAirplaneSpeed1 : departingPlaneStatusJSON.flightTracks[j].positions[1].speedMPH,
					departingAirplaneAlt1   : departingPlaneStatusJSON.flightTracks[j].positions[1].altitudeFt,
					departingAirplaneSource1 : departingPlaneStatusJSON.flightTracks[j].positions[1].source,
					departingAirplaneDate1  : departingPlaneStatusJSON.flightTracks[j].positions[1].date

				}; // departingAirplaneStatus
				j++;
			} // while j
		} // if
	} // if
}

function updateAirports() {
	console.log("updateAirports");
	// TODO we only want to read the airport list once when the page initially loads
	//      rather than every time we update the status of airports we are tracking
	var airportListURL = "https://www.airmanopus.net/cgi-bin/airportlist.csv";
	var airportListGet = new XMLHttpRequest();
	airportListGet.open('GET',airportListURL,false);
	airportListGet.send();

	var airportListStatus = (airportListGet.statusText);
	var airportList = (airportListGet.responseText);
	var airports = CSVToArray(airportList);	// array of airport IATA identifiers and corresponding coordinates

        const numAirports = 533;		// number of airports we can check status on 			
	var airportDelayString; 		// will be the contents of the airports div
	const viewportDistance = 50;		// watch airports for delays within this many miles
	const zoomedViewportDistance = 35; 	// within this many miles of an airport get detailed flight info
	const pi = 3.14159265359;		// pi
	const R = 3959; 			// approximate radius of earth in miles

	const METERS_TO_MILES = 1609.344;	// meters in one mile
	
	const NUM_HOURS_FLIGHTS = 5;		// get arr and dep flights for this many hours from now



	flightStatusCodes = {
		'A' 	: 'active',
		'C'  	: 'canceled',
		'D' 	: 'diverted',
		'L'	: 'landed',
		'R'	: 'redirected',
		'S'	: 'scheduled'
	};

	document.getElementById("airportsDelays").innerHTML = "<br><i>Delay status for airports within " + viewportDistance + " mi</i><br>";
	document.getElementById("airportsDelays").innerHTML += "<i>Flight information for airports within " + zoomedViewportDistance + " mi</i><br><br>";
	
	// we need to check all of the possible US airports to see if they are within viewportDistance of us
	for (var j = 0; j < numAirports; j++)
    	{
		var iataIdentifier = airports[j][0];			// 3 letter iata identifier
		var myLat = lat;					// my latitude
		var myLon = lon;					// my longitude
		var airportLat = airports[j][1];			// airport latitude
		var airportLon	= airports[j][2];			// airport longitude
	

		// how far away are we from the airport
		var dLat = ((airportLat-myLat) * (pi/180));
		var dLon = ((airportLon-myLon) * (pi/180));
		var myLat = (lat * (pi/180));
		var airportLatRad = (airportLat * (pi/180));

		var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
			Math.sin(dLon/2) * Math.sin(dLon/2) * Math.cos(myLat) * Math.cos(airportLatRad); 
		var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
		var distance = R * c;					// distance to airport as the crow flies

		// we ignore all airports outside viewportDistance
		if ( distance <= viewportDistance ) 
		{
			updateWeather(lat,lon)
			updateTraffic(lat,lon,airportLat,airportLon,iataIdentifier,distance);
			updateDelays(iataIdentifier);

			// if we are within zoomedViewportDistance mi of an airport we want to see its incoming and outgoing flights
			if ( distance <= zoomedViewportDistance )
			{
				console.log("processing airport ",iataIdentifier);
				updateDepartures(iataIdentifier);
				updateArrivals(iataIdentifier);
			} 
		}
	} 
}




function initialize() {
	var map;
         if (navigator.geolocation) {
		var mapFirstDraw = true; // true until initial map is drawn, false thereafter
                navigator.geolocation.watchPosition(function(position){
			if (mapFirstDraw)
			{
				// init and draw the initial map
				lat = position.coords.latitude;
				lon = position.coords.longitude;
				console.log("Initial position " + lat + "," + lon);		
				// the map
				map = L.mapbox.map('map', 'airmanopus.hm9c0o4f', {
					center: [lat, lon],
					zoom: 14,
					inertia: true,
					watch: true,
					enableHighAccuracy: true,
					maximumAge: 25000,
					trackResize: true,
					attributionControl : true,
					setView : true,
				});
				mapFirstDraw = false;
			} else {
				// update map view to new location
				lat = position.coords.latitude;
				lon = position.coords.longitude;

				// pan the map to current coordinates 
				map.setView([lat, lon]);
				console.log(lat, lon);

				updateAirports();
            		}
		


		}); 
	} 
} 
</script>
<style>
html, body, #map {
	width: 100%;
	height: 65%;
	padding: 0;
	margin: 0;
}
</style>
</head>
<body onload="initialize()">
<div id="top-title"><img src="drivinandflyin.png" alt="Drivin' and Flyin'"></div>
<div id="map"></div>
<div id="localWeather" class="weatherDisplay"></div>
<div id="airportsDelays" class="Inconsolata"></div>
<div id="airportsWeather" class="Inconsolata"></div>
<div id="airportsTraffic" class="Inconsolata"></div>
<div id="airportsDepartures" class="Inconsolata"></div>
<div id="airportsArrivals" class="Inconsolata"></div>
<div id="footer" class="weatherDisplay">
<pre>
Weather powered by: <a href="https://www.worldweatheronline.com" target="_blank">World Weather Online</a>
Flight data &copy; <a href="https://developer.flightstats.com/" target="_blank">Flightstats</a>
Maps &copy;<a href="https://www.mapbox.com/" target="_blank">Mapbox</a> &copy;<a href="https://www.openstreetmap.org/" target="_blank">OpenStreetMap Contributors</a> 
Traffic data &copy;<a href="https://dev.tomtom.com" target="_blank">TomTom</a>
Remaining &copy; 2014 airmanopus
<a href="https://airmanopus.net/weathercheck/COPYING">COPYING</a> (GPLv3) <a href="https://www.airmanopus.net/weathercheck/privacy.html">Privacy</a> <a href="https://www.github.com/airmanopus/weathercheck">github</a>
</pre>
</div>



</html>

