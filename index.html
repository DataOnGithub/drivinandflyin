<!DOCTYPE html>
<html>
<head>
<title>ForwardObserver</title>
<meta http-equiv="Content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=0" />
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript">
	var lat;		// current location
	var lon;

	var oldLat;		// most recent location
	var oldLon;

	var newLat;		// new location moving forward
	var newLon;

	var newTime;
	var initialTime;

	var speed;
	var moveDistance;
	var moveTime;

	var timeOfDay = new Date();
	var initialTime = timeOfDay.getTime();

function getCookie(cname)
{
	var name = cname + "=";
	var ca = document.cookie.split(';');
	for(var i=0; i<ca.length; i++)
	  {
	  var c = ca[i].trim();
	  if (c.indexOf(name)==0) return c.substring(name.length,c.length);
	  }
	return "";
} 	


function geoError()
{
	document.write("Da FUQ? Unable to perform geolocation!")
}

function haversineDistance(lat1,lon1,lat2,lon2)
{
	var R = 3958.6; // mi
	var d = Math.acos(Math.sin(lat1)*Math.sin(lat2) + 
			  Math.cos(lat1)*Math.cos(lat2) *
			  Math.cos(lon2-lon1)) * R;	
	return d;
}

function calculateBearing(lat1,lat2,dlon)
{
	var y = Math.sin(dLon) * Math.cos(lat2);
	var x = Math.cos(lat1)*Math.sin(lat2) -
		Math.sin(lat1)*Math.cos(lat2)*Math.cos(dLon);
	var bearing = Math.atan2(y, x).toDeg();
	// bearing needs to be 0 to 359 degrees
	return bearing;
}

function tomTomTraffic(latitude, longitude, boxSize, speed)
{
	// need to calc the size of the bounding box we want to display using current coordinates
	// as we go faster we want to display a bigger box
	// we are at the close side of a box that extends out over the direction we are moving
	
	var x1,y1,x2,y2;
	var tomTomTrafficURL="https://api.tomtom.com/lbs/services/trafficIcons/3/s1/34.043985,-118.266328,34.06,-118.28/7/-1/json?language=en&originalPosition=true&key=q3dh8pqnwmbdrvwctrgvm6nu";
	var tomTomTraffic = XMLHttpRequest();
	tomTomTraffic.open('GET',tomTomTrafficURL,false);
	tomTomTraffic.send();
	var tomTomResponse = tomTomTraffic.responseText;
	var tomTomStatus = tomTomTraffic.statusText;
}

function weather(latitude,longitude)
{    
	weatherURL = "http://api.worldweatheronline.com/free/v1/weather.ashx?q=" + latitude + "%2C" + longitude + "&format=json&num_of_days=1&includelocation=yes&show_comments=no&key=kc2u593rw3h5bp2pga7fs7ut";
	weather = XMLHttpRequest();
	weather.open('GWT',weatherURL,false);
	weather.send();
	if (weather.statusText = "200 OK") {
		weather.innerHTML = weather.responseText;
	}
}


function haveACoke(latitude, longitude)
{
	CokeURL="http://api.cokecce.com/v1/location/search/?latitude=" + latitude + "&longitude=" + longitude + "&rangeKilometers=2&maxLocations=1&format=json&apiKey=bpw7n273sy7rvsyppuks6rma"
	locateCoke = XMLHttpRequest();
	locateCoke.open('GET',CokeURL,false);
	locateCoke.send();
	console.log(locateCoke.responseText);
	if (locateCoke.status = 200){
		returnString = cokeLocations.customers[0].address + "," + codeLocations.customers[0].distance;
	}
		
}

function updateLocation()
{

	if (navigator.geolocation) {
		navigator.geolocation.getCurrentPosition(function(position) {

			// keep our last position
			oldLat = position.coords.latitude;
			oldLon = position.coords.longitude;

			console.log(oldLat,oldLon);

			// get the time
			//var newDate = new Date();
			//var datetime = newDate.timeNow();

			// get the new position
			// may be small difference if not moving very fast
			lat = position.coords.latitude;
			lon = position.coords.longitude;

			console.log(lat,lon);

			coordinatesText = document.getElementById("coordinates");
			coordinatesText.textContent = "lat : "+ lat + " lon: " + lon;

			haveACokeResponse = haveACoke(lat,lon);
			haveACokeText = document.getElementById("haveACoke");
			haveACokeText.textContent = "Coke is at " + haveACokeResponse

			// how far have we moved and how much time did it take
			moveDistance = haversineDistance(lat,lon,newLat,newLon);		
			moveTime = (newTime - initialTime);
		
			// as Newton pointed out d times t
			speed = (moveDistance * moveTime);
			speedText = document.GetElementById('speed')
			speedText.textContent = speed + " mph";
		});
	}
}

// update when position of device changes
watchedPosition = navigator.geolocation.watchPosition(updateLocation, geoError, { enableHighAccuracy: true, maximumAge: 6000, timeout: 3000 });

</script>
</head>

<body onLoad="updateLocation()">
	<!-- content goes here-->
	<div id="header"><pre>whatever the name of this app will be</pre></div>
	<div id="coordinates"></div>
	<div id="haveACoke"></div>
	<div id="speed"></div>
	<div id="tomTomTraffic"></div>
	<div id="weather"></div>
</body>
</html>
