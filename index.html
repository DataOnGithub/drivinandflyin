<!DOCTYPE HTML>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link href='https://fonts.googleapis.com/css?family=Arimo:400,700,400italic|Oxygen' rel='stylesheet' type='text/css'>
<link href='https://fonts.googleapis.com/css?family=Inconsolata:400,700' rel='stylesheet' type='text/css'>
<link rel="apple-touch-icon-precomposed" href="somepath/image.png" />
<link rel="StyleSheet" href="https://www.airmanopus.net/weathercheck/iphone.css" type="text/css">

<script src='https://api.tiles.mapbox.com/mapbox.js/v1.6.4/mapbox.js'></script>
<link href='https://api.tiles.mapbox.com/mapbox.js/v1.6.4/mapbox.css' rel='stylesheet' />
<script src='https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-osm/v0.1.0/leaflet-osm.js'></script>

<script type="text/javascript">
	// CSVToArray (c) ben nadel
	// http://www.bennadel.com/blog/1504-ask-ben-parsing-csv-strings-with-javascript-exec-regular-expression-command.htm 
	// 
	// This will parse a delimited string into an array of
	// arrays. The default delimiter is the comma, but this
	// can be overriden in the second argument.
	function CSVToArray( strData, strDelimiter ){
	// Check to see if the delimiter is defined. If not,
	// then default to comma.
	strDelimiter = (strDelimiter || ",");
	 
	// Create a regular expression to parse the CSV values.
	var objPattern = new RegExp(
	(
	// Delimiters.
	"(\\" + strDelimiter + "|\\r?\\n|\\r|^)" +
	 
	// Quoted fields.
	"(?:\"([^\"]*(?:\"\"[^\"]*)*)\"|" +
	 
	// Standard fields.
	"([^\"\\" + strDelimiter + "\\r\\n]*))"
	),
	"gi"
	);
	 
	 
	// Create an array to hold our data. Give the array
	// a default empty first row.
	var arrData = [[]];
	 
	// Create an array to hold our individual pattern
	// matching groups.
	var arrMatches = null;
	 
	 
	// Keep looping over the regular expression matches
	// until we can no longer find a match.
	while (arrMatches = objPattern.exec( strData )){
	 
	// Get the delimiter that was found.
	var strMatchedDelimiter = arrMatches[ 1 ];
	 
	// Check to see if the given delimiter has a length
	// (is not the start of string) and if it matches
	// field delimiter. If id does not, then we know
	// that this delimiter is a row delimiter.
	if (
	strMatchedDelimiter.length &&
	(strMatchedDelimiter != strDelimiter)
	){
	 
	// Since we have reached a new row of data,
	// add an empty row to our data array.
	arrData.push( [] );
	 
	}
	 
	 
	// Now that we have our delimiter out of the way,
	// let's check to see which kind of value we
	// captured (quoted or unquoted).
	if (arrMatches[ 2 ]){
	 
	// We found a quoted value. When we capture
	// this value, unescape any double quotes.
	var strMatchedValue = arrMatches[ 2 ].replace(
	new RegExp( "\"\"", "g" ),
	"\""
	);
	 
	} else {
	 
	// We found a non-quoted value.
	var strMatchedValue = arrMatches[ 3 ];
	 
	}
	 
	 
	// Now that we have our value string, let's add
	// it to the data array.
	arrData[ arrData.length - 1 ].push( strMatchedValue );
	}
	 
	// Return the parsed data.
	return( arrData );
	}
 
	// end of bens code

	// start of mine

function geoError() {
        document.write("<span class='errorText'>Geolocation failed. You may need to enable location services on your device.</span>");
}

function updateWeather() {
        // get current weather conditions 

	var weatherGetURL = "https://api.worldweatheronline.com/free/v1/weather.ashx?q=" + lat + "%2C" + lon + "&format=json&extra=localObsTime%2CisDayTime&num_of_days=1&date=tomorrow&includelocation=yes&key=kc2u593rw3h5bp2pga7fs7ut";
        var weatherGet = new XMLHttpRequest();
        weatherGet.open('GET',weatherGetURL,false);
        weatherGet.send();
	
        var weatherResponse = JSON.parse(weatherGet.responseText);
        console.log("wwo " + weatherGet.statusText);
        var weatherDesc = weatherResponse.data.current_condition[0].weatherDesc[0].value;
        var temp_F = weatherResponse.data.current_condition[0].temp_F;
        var visibility = weatherResponse.data.current_condition[0].visibility;
        var humidity = weatherResponse.data.current_condition[0].humidity;   
        var precipMM = weatherResponse.data.current_condition[0].precipMM;
        var windSpeed = weatherResponse.data.weather[0].windspeedMiles;
        var windDir = weatherResponse.data.weather[0].winddirection;
        var obsTime = weatherResponse.data.current_condition[0].localObsDateTime;
        var city = weatherResponse.data.nearest_area[0].areaName[0].value;
        var state = weatherResponse.data.nearest_area[0].region[0].value;


        // calculate heat index and wind chill
        var tempSquared = temp_F * temp_F;
        var relHSquared = humidity * humidity;
        var heatIndex = Math.round(-42.379 + (2.04901523 * temp_F) + (10.14333127 * humidity) - (0.22475541 * temp_F * humidity) - ( .00683783 * tempSquared) - (.05481717 * relHSquared) + ( .00122874 * tempSquared * humidity) + (.00085282 * temp_F * relHSquared) - (.00000199 * tempSquared * relHSquared));
        var windChill = Math.round(35.74 + (0.6215 * temp_F) - (35.75 * Math.pow(windSpeed,0.16)) + (0.4275 * temp_F * Math.pow(windSpeed,0.16)));

        // TODO re add one line short term forecast 
        
        var weatherIconURL = weatherResponse.data.weather[0].weatherIconURL;
        var weatherInfoURL = weatherResponse.data.weather[0].weatherURL;
        
        weather.innerHTML = ""; // clear last observation data
        weather.innerHTML += city + ", " + state + "<br>";
        weather.innerHTML += lat.toPrecision(9) + "," + lon.toPrecision(9) + "<br>";
        weather.innerHTML += weatherDesc + " and " + temp_F + "\xB0" + "F<br>";
        weather.innerHTML += "Humidity " + humidity + "% Visibility " + visibility + " mi<br>";
        weather.innerHTML += "Wind " + windDir + " at " + windSpeed + "mph<br>";
        if (temp_F < 45){
                weather.innerHTML += "Wind Chill " + windChill + "\xB0" + "F<br>";
        }
        if (temp_F > 70){
                weather.innerHTML += "Heat Index " + heatIndex + "\xB0" + "F<br>";
        }
        weather.innerHTML += (precipMM>0.0)?"Precip (mm) "+ precipMM + "<br>":"Precip none<br>";
        weather.innerHTML += "Observation time " + obsTime + "<br>";

}

function updateWeatherAtAirport() {
  // get current weather conditions st one of the airports we may be going to 
	var weatherLat = arguments[0];
	var weatherLon = arguments[1];

        var weatherGetURL = "https://api.worldweatheronline.com/free/v1/weather.ashx?q=" + weatherLat + "%2C" + weatherLon + "&format=json&extra=localObsTime%2CisDayTime&num_of_days=1&date=tomorrow&includelocation=yes&key=kc2u593rw3h5bp2pga7fs7ut";
        var weatherGet = new XMLHttpRequest();
        weatherGet.open('GET',weatherGetURL,false);
        weatherGet.send();
        
        var weatherResponse = JSON.parse(weatherGet.responseText);
        var weatherDesc = weatherResponse.data.current_condition[0].weatherDesc[0].value;
        var temp_F = weatherResponse.data.current_condition[0].temp_F;
        var visibility = weatherResponse.data.current_condition[0].visibility;
        var precipMM = weatherResponse.data.current_condition[0].precipMM;
        var windSpeed = weatherResponse.data.weather[0].windspeedMiles;
        var windDir = weatherResponse.data.weather[0].winddirection;
        var obsTime = weatherResponse.data.current_condition[0].localObsDateTime;
        
	document.getElementById("airports").innerHTML += "Currently " + weatherDesc + " and " + temp_F + "\xB0" + "F<br>";

}

function updateAirports() {

	var airportListURL = "https://www.airmanopus.net/cgi-bin/airportlist.csv";
	var airportListGet = new XMLHttpRequest();
	airportListGet.open('GET',airportListURL,false);
	airportListGet.send();

	var airportListStatus = (airportListGet.statusText);
	var airportList = (airportListGet.responseText);
	var airports = CSVToArray(airportList);	// array of airport IATA identifiers and corresponding coordinates

        const numAirports = 533;		// number of airports we can check status on 			
	var airportDelayString; 		// will be the contents of the airports div
	const viewportDistance = 50;		// watch airports for delays within this many miles
	const zoomedViewportDistance = 35; 	// within this many miles of an airport get detailed flight info
	const pi = 3.14159265359;		// pi
	const R = 3959; 			// approximate radius of earth in miles

	const METERS_TO_MILES = 1609.344;	// meters in one mile
	
	const NUM_HOURS_FLIGHTS = 5;		// get arr and dep flights for this many hours from now

	var d = new Date();			// current date to use for requesting flight data for an airport
	var year = d.getFullYear();		// current year
	var month = d.getMonth();		// current month
	var day = d.getDay();			// current day

	document.getElementById("airports").innerHTML = "<br><i>Delay status for airports within " + viewportDistance + " mi</i><br>";
	document.getElementById("airports").innerHTML += "<i>Flight information for airports within " + zoomedViewportDistance + " mi</i><br><br>";
	
	// we need to check all of the airports to see if they are within viewportDistance of us
	for (var j = 0; j < numAirports; j++) {
		var iataIdentifier = airports[j][0];			// 3 letter iata identifier
		var myLat = lat;					// my latitude
		var myLon = lon;					// my longitude
		var airportLat = airports[j][1];			// airport latitude
		var airportLon	= airports[j][2];			// airport longitude
	
		// how far away are we from the airport
		var dLat = ((airportLat-myLat) * (pi/180));
		var dLon = ((airportLon-myLon) * (pi/180));
		var myLat = (lat * (pi/180));
		var airportLatRad = (airportLat * (pi/180));

		var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
			Math.sin(dLon/2) * Math.sin(dLon/2) * Math.cos(myLat) * Math.cos(airportLatRad); 
		var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
		var distance = R * c;					// distance to airport as the crow flies

		// we ignore all airports outside viewportDistance
		if ( distance <= viewportDistance ) 
		{
		
			// see if this airport has a delay or closure notice posted
			var airportStatusURL="https://www.airmanopus.net/cgi-bin/airports.cgi?iata=" + iataIdentifier;
			var airportStatusGet = new XMLHttpRequest();
			airportStatusGet.open('GET',airportStatusURL,false);
			airportStatusGet.send();
			var airportStatusResponse = airportStatusGet.responseText;
			// if we see a less than chr we didnt get a json response so no delays
			// probably a smaller airport that FAA doesnt keep status on
			// we always display the delay text
			if ( airportStatusResponse.charAt(0) != "<" )
			{
				var airportStatus = JSON.parse(airportStatusGet.responseText);
				var airportIATA = airportStatus.IATA;
				var airportName = airportStatus.name;
				var delayStatus = airportStatus.delay;
				var airportDelayReason = airportStatus.status.reason;
				var airportClosureBegin = airportStatus.status.closureBegin;
				var airportClosureEnd = airportStatus.status.closureEnd;
				var airportMinDelay = airportStatus.status.MinDelay;
				var airportMaxDelay = airportStatus.status.MaxDelay;
				var airportAvgDelay = airportStatus.status.AvgDelay;
				
				// add this airport to the map
				//L.marker([airportLat, airportLon]).addTo(map);

				// name and IATA always display if within viewPortdistance 	
				document.getElementById("airports").innerHTML += "<span class='airportTitle'>";
				document.getElementById("airports").innerHTML += airportName + " (" + airportIATA + ")<br>";
				document.getElementById("airports").innerHTML += airportDelayReason + "<br>";
				document.getElementById("airports").innerHTML += "</span>";
				updateWeatherAtAirport(airportLat,airportLon);
				// display closure info only if airport is closed 
				if ( airportClosureBegin != "")
				{
					 document.getElementById("airports").innerHTML +=  "<br>Closed from " + airportClosureBegin + " to " + airportClosureEnd;
				
				} 

				// display delay reason only when there is a delay
				if  (delayStatus != "false")
				{
					// display delay times only if we received them
					if (airportMinDelay != null)
					{
					document.getElementById("airports").innerHTML += "<br>Min " + airportMinDelay + " Max " + airportMaxDelay + " Avg " + airportAvgDelay;
					}
				}
			} // if delays


			// if we are within zoomedViewportDistance mi of an airport we want to see its incoming and outgoing flights
			if ( distance <= zoomedViewportDistance )
			{

				// check traffic to get estimate on when will we get to the airport 
				// we always display driving  ETA from our location to each airport
				var airportETAGet = new XMLHttpRequest();
				var airportETAURL="https://api.tomtom.com/lbs/services/route/3/" + lat + "," + lon + ":" + airportLat + "," + airportLon + "/Quickest/json?avoidTraffic=true&includeTraffic=true&day=today&iqRoutes=2&includeInstructions=true&key=knpmsu5p59rxdud2rmghsxd7"
				var airportETAProcess="https://www.airmanopus.net/cgi-bin/tomtom.cgi?" + airportETAURL;
				airportETAGet.open('GET', airportETAProcess, false);
				airportETAGet.send();
				
				airportETAParsed=JSON.parse(airportETAGet.responseText);
				airportETA = airportETAParsed.route.summary.arrivalOverview.time;
				if (airportIATA != null)
				{
					document.getElementById("airports").innerHTML += "This airport is approx " + distance.toFixed(2) + " miles away. <br> Your estimated arrival time at " + airportIATA + " is " + airportETA + ".<br><br>";
			 	}	


				// use the date at this moment
				var currentTime = new Date();
				var hour = currentTime.getHours();
				var day = currentTime.getDate();
				var month = currentTime.getMonth() + 1;
				var year = currentTime.getFullYear();
				
				
				// departures
				var departingFlightsGet = new XMLHttpRequest();
				var departingFlightsURL="https://api.flightstats.com/flex/fids/rest/v1/json/" + airportIATA + "/departures?appId=03ac1ffa&appKey=0505f46298d4dc8c52468a3338aa7453&codeType=IATA&requestedFields=airlineLogoUrlPng%2CoperatingAirlineName%2Cflight%2CdestinationFamiliarName%2CscheduledTime%2Cgate%2CremarksWithTime%2ClastUpdatedTime&sortFields=currentTime,destinationFamiliarName%2Cflight%2CscheduledTime&timeFormat=24&timeWindowBegin=30&timeWindowEnd=30&lateMinutes=15&boardingMinutes=45&useRunwayTimes=true&excludeCargoOnlyFlights=true";
				var departingFlightsProcess="https://www.airmanopus.net/cgi-bin/departures.cgi?" + departingFlightsURL;
				departingFlightsGet.open('GET', departingFlightsProcess, false);
				departingFlightsGet.send();
				var departingFlightsJSON = JSON.parse(departingFlightsGet.responseText);
			
				// skip display iffn there are no departures scheduled
				// often occurs between 0000-0500 airport local time
				if (departingFlightsJSON.fidsData.length > 0)
				{
					document.getElementById("airports").innerHTML += "Departures<br><br>";
					var i = 0;
					while ( i < departingFlightsJSON.fidsData.length )
					{ 
						var departureAirlineName = departingFlightsJSON.fidsData[i].operatingAirlineName;
						var departureAirlineLogo = departingFlightsJSON.fidsData[i].airlineLogoUrlPng;
						var departureFlight = departingFlightsJSON.fidsData[i].flight;
						var departureDestination = departingFlightsJSON.fidsData[i].destinationFamiliarName;
						var departureScheduledTime = departingFlightsJSON.fidsData[i].scheduledTime;
						var departureGate = departingFlightsJSON.fidsData[i].gate;
						var departureRemarks = departingFlightsJSON.fidsData[i].remarksWithTime;
						var departureGateDisplay;

						i++;

						// make dynamic changes
						if ( departureGate == null )
						{
							departureGateDisplay = " ";
						} else {
							departureGateDisplay = "<b>Gate " + departureGate + "</b>";
						}      

						if ( departureRemarks = "Boarding" )
						{
							departureRemarksTemp = "<span style='color:green;font-weight:bold'>" + departureRemarks + "</span>";
							departureRemarks = departureRemarksTemp;
						}
					
						if ( departureRemarks = "On-time" )
						{
							departureRemarksTemp = "<span style='color:green'>" + departureRemarks + "</span>";
						}

						document.getElementById("airports").innerHTML += "<p><img src=https://" + departureAirlineLogo.substring(7) + " alt='" + departureAirlineName + "' height=18 width=55>" + departureFlight + " to " + departureDestination + " at " + departureScheduledTime + " from " + departureGateDisplay + " " + departureRemarks + "</p>";

						} // while			
					} // if


					// arrivals
					var arrivingFlightsGet = new XMLHttpRequest();
					var arrivingFlightsURL = "https://api.flightstats.com/flex/fids/rest/v1/json/" + airportIATA + "/arrivals?appId=03ac1ffa&appKey=0505f46298d4dc8c52468a3338aa7453&requestedFields=flightId%2CairlineLogoUrlPng%2CoperatingAirlineName%2Cflight%2Ccity%2CscheduledTime%2Cgate%2Cbaggage%2CremarksWithTime%2Cgate%2ClastUpdatedTime&sortFields=currentTime,city%2Cflight%2CscheduledTime&timeFormat=24&timeWindowBegin=30&timeWindowEnd=30&lateMinutes=15&boardingMinutes=45&useRunwayTimes=true&excludeCargoOnlyFlights=true"; 
					var arrivingFlightsProcess="https://www.airmanopus.net/cgi-bin/arrivals.cgi?" + arrivingFlightsURL;
					arrivingFlightsGet.open('GET', arrivingFlightsProcess, false);
					arrivingFlightsGet.send();
					var arrivingFlightsJSON = JSON.parse(arrivingFlightsGet.responseText);

					// skip display there are no arrivals scheduled                     
					if (arrivingFlightsJSON.fidsData.length > 0)
					{

						document.getElementById("airports").innerHTML += "<br>Arrivals<br>";
						var i = 0;
						while ( i < arrivingFlightsJSON.fidsData.length ) 
						{
							var arrivalAirlineLogo = arrivingFlightsJSON.fidsData[i].airlineLogoUrlPng; 
							var arrivalAirlineName = arrivingFlightsJSON.fidsData[i].operatingAirlineName;
							var arrivalFlight = arrivingFlightsJSON.fidsData[i].flight;
							var arrivalCity = arrivingFlightsJSON.fidsData[i].city;
							var arrivalScheduled = arrivingFlightsJSON.fidsData[i].scheduledTime;
							var arrivalGate = arrivingFlightsJSON.fidsData[i].gate;
							var arrivalBaggage = arrivingFlightsJSON.fidsData[i].baggage;
							var arrivalRemarks = arrivingFlightsJSON.fidsData[i].remarksWithTime;
							var arrivalFlightID = arrivingFlightsJSON.fidsData[i].flightId;
							var arrivalBaggageDisplay;
							var arrivalGateDisplay;

							// make dynamic changes

							if ( arrivalGate == null )
							{
								arrivalGateDisplay = " ";
							} else {
								arrivalGateDisplay = " <b>Gate " + arrivalGate + "</b>";
							}

							if ( arrivalBaggage == null )
							{
								arrivalBaggageDisplay = " ";
							} else {
								arrivalBaggageDisplay = "<b>Carousel " + arrivalBaggage + "</b>";
							}
			
							if ( arrivalRemarks.indexOf("Estimated") != -1)
							{				
								arrivalRemarksTemp = "<span style='color:red'>" + arrivalRemarks + "</span>";
								arrivalRemarks = arrivalRemarksTemp;
							}
							if ( arrivalRemarks.indexOf("Cancelled") != -1)
							{                               
								arrivalRemarksTemp = "<span style='color:red;font-weight:bold'>" + arrivalRemarks + "</span>";
								arrivalRemarks = arrivalRemarksTemp;
							}


							if ( arrivalRemarks == "Arrived On-Time" )
							{
								arrivalRemarksTemp = "<span style='color:green;font-weight:bold'>" + arrivalRemarks + "</span>";
								arrivalRemarks = arrivalRemarksTemp;
							}

							// display status info line fer this flight	
							document.getElementById("airports").innerHTML += "<p class=airportFlights><img src=https://" + arrivalAirlineLogo.substring(7) + " alt='" + arrivalAirlineName + "' height=18 width=55> " +  arrivalFlight + " from " + arrivalCity + " " + arrivalScheduled + arrivalGateDisplay + " " + arrivalBaggageDisplay + " " + arrivalRemarks + "</p>";
							
							i++;


						} // while
					} // if
		
				} // airports in zoom range




			} // if airports in viewport range
	} // j
} // updateAirports	 

var mapFirstDraw = true; // true until initial map is drawn, false thereafter

function initialize() {
var map;
         if (navigator.geolocation) {
                navigator.geolocation.watchPosition(function(position){
			if (mapFirstDraw)
			{
				// init and draw the initial map
				lat = position.coords.latitude;
				lon = position.coords.longitude;
		
				// the map
				map = L.mapbox.map('map', 'airmanopus.hm9c0o4f', {
					center: [lat, lon],
					zoom: 14,
					inertia: true,
					watch: true,
					enableHighAccuracy: true,
					maximumAge: 3000,
					trackResize: true,
					attributionControl : true,
					setView : true,
				});
				mapFirstDraw = false;
			} else {
				// update map view to new location
				lat = position.coords.latitude;
				lon = position.coords.longitude;

				// pan the map to current coordinates 
				map.setView([lat, lon]);
				console.log(lat, lon);
                	}
		
			// we are likely moving so we want to keep these updated
			updateWeather();
			updateAirports();



	

		
		}); // positien
	} // geolocatien
} // initializze
</script>
<style>
html, body, #map {
	width: 100%;
	height: 65%;
	padding: 0;
	margin: 0;
}
</style>
</head>
<body onload="initialize()">
<div id="top-title"><img src="drivinandflyin.png" alt="Drivin' and Flyin'"></div>
<div id="map"></div>
<div id="weather" class="weatherDisplay"></div>
<div id="airports" class="Inconsolata"></div>
<div id="footer" class="weatherDisplay">
<pre>
Weather powered by: <a href="https://www.worldweatheronline.com" target="_blank">World Weather Online</a>
Flight data &copy; <a href="https://developer.flightstats.com/" target="_blank">Flightstats</a>
Maps &copy;<a href="https://www.mapbox.com/" target="_blank">Mapbox</a> &copy;<a href="https://www.openstreetmap.org/" target="_blank">OpenStreetMap Contributors</a> 
Traffic data &copy;<a href="https://dev.tomtom.com" target="_blank">TomTom</a>
Remaining &copy; 2014 airmanopus
<a href="https://airmanopus.net/weathercheck/COPYING">COPYING</a> (GPLv3) <a href="https://www.airmanopus.net/weathercheck/privacy.html">Privacy</a> <a href="https://www.github.com/airmanopus/weathercheck">github</a>
</pre>
</div>



</html>


