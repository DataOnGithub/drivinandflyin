<!DOCTYPE HTML>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link href='https://fonts.googleapis.com/css?family=Arimo:400,700,400italic|Oxygen' rel='stylesheet' type='text/css'>
<link rel="apple-touch-icon-precomposed" href="somepath/image.png" />
<link rel="StyleSheet" href="https://www.airmanopus.net/weathercheck/iphone.css" type="text/css">

<script src='https://api.tiles.mapbox.com/mapbox.js/v1.6.2/mapbox.js'></script>
<link href='https://api.tiles.mapbox.com/mapbox.js/v1.6.2/mapbox.css' rel='stylesheet' />
<script src='https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-osm/v0.1.0/leaflet-osm.js'></script>

<script type="text/javascript">
	// CSVToArray (c) ben nadel
	// http://www.bennadel.com/blog/1504-ask-ben-parsing-csv-strings-with-javascript-exec-regular-expression-command.htm 
	// 
	// This will parse a delimited string into an array of
	// arrays. The default delimiter is the comma, but this
	// can be overriden in the second argument.
	function CSVToArray( strData, strDelimiter ){
	// Check to see if the delimiter is defined. If not,
	// then default to comma.
	strDelimiter = (strDelimiter || ",");
	 
	// Create a regular expression to parse the CSV values.
	var objPattern = new RegExp(
	(
	// Delimiters.
	"(\\" + strDelimiter + "|\\r?\\n|\\r|^)" +
	 
	// Quoted fields.
	"(?:\"([^\"]*(?:\"\"[^\"]*)*)\"|" +
	 
	// Standard fields.
	"([^\"\\" + strDelimiter + "\\r\\n]*))"
	),
	"gi"
	);
	 
	 
	// Create an array to hold our data. Give the array
	// a default empty first row.
	var arrData = [[]];
	 
	// Create an array to hold our individual pattern
	// matching groups.
	var arrMatches = null;
	 
	 
	// Keep looping over the regular expression matches
	// until we can no longer find a match.
	while (arrMatches = objPattern.exec( strData )){
	 
	// Get the delimiter that was found.
	var strMatchedDelimiter = arrMatches[ 1 ];
	 
	// Check to see if the given delimiter has a length
	// (is not the start of string) and if it matches
	// field delimiter. If id does not, then we know
	// that this delimiter is a row delimiter.
	if (
	strMatchedDelimiter.length &&
	(strMatchedDelimiter != strDelimiter)
	){
	 
	// Since we have reached a new row of data,
	// add an empty row to our data array.
	arrData.push( [] );
	 
	}
	 
	 
	// Now that we have our delimiter out of the way,
	// let's check to see which kind of value we
	// captured (quoted or unquoted).
	if (arrMatches[ 2 ]){
	 
	// We found a quoted value. When we capture
	// this value, unescape any double quotes.
	var strMatchedValue = arrMatches[ 2 ].replace(
	new RegExp( "\"\"", "g" ),
	"\""
	);
	 
	} else {
	 
	// We found a non-quoted value.
	var strMatchedValue = arrMatches[ 3 ];
	 
	}
	 
	 
	// Now that we have our value string, let's add
	// it to the data array.
	arrData[ arrData.length - 1 ].push( strMatchedValue );
	}
	 
	// Return the parsed data.
	return( arrData );
	}
 
	// end of bens code

	// start of mine

function geoError(){
        document.write("<span class='errorText'>Geolocation failed. You may need to enable location services on your device.</span>");
}

function updateWeather(){
	// get weather data for current location and time	
	
	// todo this is kinda fugly
	// 	better to do this as a weatherConditions object that has some reuse possibility

	// weather data is courtesy http://www.worldweatheronline.com free api
	// via mashery.com
	const weatherDataElement = 0;		// data.current_condition[weatherDataElement]
	const weatherDisplaySize = 10;		// size of weatherDisplay array	
	var localWeatherURL="https://www.airmanopus.net/cgi-bin/worldweatheronline.cgi?lat=" + lat + "&lon=" + lon;
	var localWeatherGet = new XMLHttpRequest();
	localWeatherGet.open('GET',localWeatherURL,false);
	localWeatherGet.send();
	var weatherConditions = JSON.parse(localWeatherGet.responseText);

	// not completely decided which fields are going to be included so these may change
	var weatherDesc = weatherConditions.data.current_condition[weatherDataElement].weatherDesc[0].value;
	var temp_F = weatherConditions.data.current_condition[weatherDataElement].temp_F;
	var visibility = weatherConditions.data.current_condition[weatherDataElement].visibility;
	var humidity = weatherConditions.data.current_condition[weatherDataElement].humidity;   
	var precipMM = weatherConditions.data.current_condition[weatherDataElement].precipMM;
	var windSpeed = weatherConditions.data.weather[weatherDataElement].windspeedMiles;
	var windDir = weatherConditions.data.weather[weatherDataElement].winddirection;
	var obsTime = weatherConditions.data.current_condition[weatherDataElement].observation_time;
	var city = weatherConditions.data.nearest_area[weatherDataElement].areaName[0].value;
	var state = weatherConditions.data.nearest_area[weatherDataElement].region[0].value;
	
	var weatherIconURL = weatherConditions.data.weather[weatherDataElement].weatherIconURL;
	var weatherInfoURL = weatherConditions.data.weather[weatherDataElement].weatherURL;

	// assemble the fields to output into one array, then loop once to display
	// TODO when we refresh after changing location we need to refresh this information as well
	weatherDisplay = new Array(weatherDisplaySize);
	weatherDisplay[0] = city + ", " + state;
	weatherDisplay[1] = lat + "," + lon;
	weatherDisplay[2] = weatherDesc + " and " + temp_F + "\xB0" + "F";
	weatherDisplay[3] = "Humidity " + humidity + "% Visibility " + visibility + " mi";
	weatherDisplay[4] = "Wind " + windDir + " at " + windSpeed + "mph";
	weatherDisplay[5] =(precipMM>0.0)?"Precip "+ precipMM:"Precip: none";
	weatherDisplay[6] = "Observed at " + obsTime + " UTC";
	weather.innerHTML += "Local Conditions<br><br>";
	for (var i = 0; i <= 6; i++)
	{
		weather.innerHTML += weatherDisplay[i] + "<br>";
	} 
	// end worldweatheronline.com 

}
function updateAirportDelays(){

	document.getElementById("airports").innerHTML += "<br>Closest Airports<br><br>";

	var airportListURL="https://www.airmanopus.net/cgi-bin/airportlist.csv";
	var airportListGet = new XMLHttpRequest();
	airportListGet.open('GET',airportListURL,false);
	airportListGet.send();

	var airportListStatus = (airportListGet.statusText);
	var airportList = (airportListGet.responseText);

	var airports = CSVToArray(airportList);	// array of airport IATA identifiers and corresponding coordinates

	const numAirports = 533;		// number of airports we can check status on 			
	var airportDelayString; 		// will be the contents of the airports div
	const viewportDistance = 75;		// watch airports for delays within this many miles
	const zoomedViewportDistance = 30; 	// within this many miles of an airport get detailed flight info
	const pi = 3.14159265359;		// pi
	const R = 3959; 			// approximate radius of earth in miles

	const METERS_TO_MILES = 1609.344;	// meters in one mile
	
	const NUM_HOURS_FLIGHTS = 5;		// get arr and dep flights for this many hours from now

	var d = new Date();			// current date to use for requesting flight data for an airport
	var year = d.getFullYear();		// current year
	var month = d.getMonth();		// current month
	var day = d.getDay();			// current day

	// we need to check all of the airports to see if they are within viewportDistance of us
	for (var j = 0; j < numAirports; j++) {
		var iataIdentifier = airports[j][0];			// 3 letter iata identifier
		var myLat = lat;					// my latitude
		var myLon = lon;					// my longitude
		var airportLat = airports[j][1];			// airport latitude
		var airportLon	= airports[j][2];			// airport longitude
	
		// how far away are we from the airport
		var dLat = ((airportLat-myLat) * (pi/180));
		var dLon = ((airportLon-myLon) * (pi/180));
		var myLat = (lat * (pi/180));
		var airportLatRad = (airportLat * (pi/180));

		var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
			Math.sin(dLon/2) * Math.sin(dLon/2) * Math.cos(myLat) * Math.cos(airportLatRad); 
		var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
		var distance = R * c;					// distance to airport in NM

		// if we are within viewportDistance look up the airport delay status and always display that result
		// we ignore airports outside viewportDistance
		 if ( distance <= viewportDistance ) 
			{
				var airportStatusURL="https://www.airmanopus.net/cgi-bin/airports.cgi?iata=" + iataIdentifier;
				var airportStatusGet = new XMLHttpRequest();
				airportStatusGet.open('GET',airportStatusURL,false);
				airportStatusGet.send();
				var airportStatusResponse = airportStatusGet.responseText;
						
				// if we see a less than chr we didnt get a json response
				// we didnt get a json response because FAA doesnt keep status on this airport
				// so we ignore this airport even though it is within viewportDistance
				if ( airportStatusResponse.charAt(0) != "<" )
				{
					var airportStatus = JSON.parse(airportStatusGet.responseText);
					
					var airportIATA = airportStatus.IATA;
					var airportName = airportStatus.name;
					var delayStatus = airportStatus.delay;
					var airportDelayReason = airportStatus.status.reason;
					var airportClosureBegin = airportStatus.status.closureBegin;
					var airportClosureEnd = airportStatus.status.closureEnd;
					var airportMinDelay = airportStatus.status.MinDelay;
					var airportMaxDelay = airportStatus.status.MaxDelay;
					var airportAvgDelay = airportStatus.status.AvgDelay;

					// name and IATA always display if within viewPortdistance 	
					document.getElementById("airports").innerHTML += "<span class='airportTitle'>";
					document.getElementById("airports").innerHTML += airportName + " (" + airportIATA + ")<br>";
					document.getElementById("airports").innerHTML += airportDelayReason + "<br>";
					document.getElementById("airports").innerHTML += "</span>";
					// display closure info only if airport is closed 
					if ( airportClosureBegin != "")
					{
						 document.getElementById("airports").innerHTML +=  "<br>Closed from " + airportClosureBegin + " to " + airportClosureEnd;
					
					} 


					// todo delay info can contain airline 3 letter codes so we want to parse those into
					//      curresponding human readable airline names 
					//	something like... cat airlineCodesNames.csv | grep \,"AEF"

					// display delay reason only when there is a delay
					if  (delayStatus != "false")
					{
						// display delay times only if we received them
						if (airportMinDelay != null)
						{
						document.getElementById("airports").innerHTML += "<br>Min " + airportMinDelay + " Max " + airportMaxDelay + " Avg " + airportAvgDelay;
						}
					}
					
					// check traffic to get estimate on when will we get to the airport 
					// we always display ETA from our location to each airport
					var airportETAGet = new XMLHttpRequest();
					var airportETAURL="https://api.tomtom.com/lbs/services/route/3/" + lat + "," + lon + ":" + airportLat + "," + airportLon + "/Quickest/json?avoidTraffic=true&includeTraffic=true&day=today&iqRoutes=2&includeInstructions=false&key=knpmsu5p59rxdud2rmghsxd7"
					var airportETAProcess="https://www.airmanopus.net/cgi-bin/tomtom.cgi?" + airportETAURL;
					console.log(airportETAProcess);
					airportETAGet.open('GET', airportETAProcess, false);
					airportETAGet.send();
					
					airportETAParsed=JSON.parse(airportETAGet.responseText);
					airportETA = airportETAParsed.route.summary.arrivalOverview.time;
					document.getElementById("airports").innerHTML += "Your est arrival time " + airportETA + "<br><br>";
				}
			} 

		// if we are within zoomedViewportDistance miles of an airport we want to see its incoming and outgoing flights
		if ( distance <= zoomedViewportDistance )
		{
			// use the date at this moment
			var currentTime = new Date();
			var hour = currentTime.getHours();
			var day = currentTime.getDate();
			var month = currentTime.getMonth() + 1;
			var year = currentTime.getFullYear();

			// departures
 			var departingFlightsGet = new XMLHttpRequest();
			var departingFlightsURL="https://api.flightstats.com/flex/flightstatus/rest/v2/json/airport/status/" + airportIATA + "/dep/" + year + "/" + month + "/" + day + "/" + hour + "?appId=03ac1ffa&appKey=0505f46298d4dc8c52468a3338aa7453&utc=false&excludeCargoOnlyFlights=true&numHours=" + NUM_HOURS_FLIGHTS;
			var departingFlightsProcess="https://www.airmanopus.net/cgi-bin/departures.cgi?" + departingFlightsURL;
			departingFlightsGet.open('GET', departingFlightsProcess, false);
			departingFlightsGet.send();
			var departingFlightsJSON = JSON.parse(departingFlightsGet.responseText);
			console.log(departingFlightsGet.statusText);
		
			// skip display there are no departures scheduled in next NUM_FLIGHTS_HOURS			
			if ( departingFlightsJSON.flightStatuses.length > 0 )
			{
				document.getElementById("airports").innerHTML += "Departures<br>";
				var i = 0;
				while ( i < departingFlightsJSON.flightStatuses.length)
				{
					document.getElementById("airports").innerHTML += departingFlightsJSON.flightStatuses[i].carrierFsCode + " Flight " + departingFlightsJSON.flightStatuses[i].flightNumber + " ";
					document.getElementById("airports").innerHTML += " departs at " + departingFlightsJSON.flightStatuses[i].departureDate.dateLocal + "<br>";
					i++;
				}
				document.getElementById("airports").innerHTML += "<br><br>";
			}	
			

			// arrivals
			var arrivingFlightsGet = new XMLHttpRequest();
			var arrivingFlightsURL = "https://api.flightstats.com/flex/flightstatus/rest/v2/json/airport/status/" + airportIATA + "/arr/" + year + "/" + month + "/" + day + "/" + hour + "?appId=03ac1ffa&appKey=0505f46298d4dc8c52468a3338aa7453&excludeCargoOnlyFlights=true&utc=false&numHours=" + NUM_HOURS_FLIGHTS;
			var arrivingFlightsProcess="https://www.airmanopus.net/cgi-bin/arrivals.cgi?" + arrivingFlightsURL;
			arrivingFlightsGet.open('GET', arrivingFlightsProcess, false);
			arrivingFlightsGet.send();
			var arrivingFlightsJSON = JSON.parse(arrivingFlightsGet.responseText);
			console.log(arrivingFlightsGet.statusText);

 			// skip display there are no departures scheduled in next NUM_FLIGHTS_HOURS                     
                        if ( arrivingFlightsJSON.flightStatuses.length > 0 )
                        {
                                document.getElementById("airports").innerHTML += "Arrivals<br>";
				var i = 0;
                                while ( i < arrivingFlightsJSON.flightStatuses.length)
                                {
                                        document.getElementById("airports").innerHTML += arrivingFlightsJSON.flightStatuses[i].carrierFsCode + " Flight " + arrivingFlightsJSON.flightStatuses[i].flightNumber + " ";
                                        document.getElementById("airports").innerHTML += " arrives at " + arrivingFlightsJSON.flightStatuses[i].arrivalDate.dateLocal + "<br>";
                                        i++;
                                }
				document.getElementById("airports").innerHTML += "<br><br>";
                        }       


			// todo menu
			// choose arrivals or departures
			// choose airline
			// choose flight

		} // zoomed
		

		} // fer 
}


function initialize(){
         if (navigator.geolocation){
                navigator.geolocation.watchPosition(function(position){
			lat = position.coords.latitude;
			lon = position.coords.longitude;

		// the map
		var map = L.mapbox.map('map', 'airmanopus.hm9c0o4f', {
			center: [lat, lon],
			zoom: 12,
			inertia: true,
			watch: true,
			enableHighAccuracy: true,
			maximumAge: 50000,
			trackResize: true,
			attributionControl : true
		});
		L.marker([lat, lon]).addTo(map);

		updateWeather();
		updateAirportDelays();

		}); // positien
	} // geolocatien
} // initializze
</script>
<style>
html, body, #map {
	width: 100%;
	height: 65%;
	padding: 0;
	margin: 0;
}
</style>
</head>
<body onload="initialize()">

<div id="map"></div>
<div id="weather" class="weatherDisplay"></div>
<div id="airports" class="airportFlights"></div>
</html>


