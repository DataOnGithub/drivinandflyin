<!DOCTYPE HTML>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link href='https://fonts.googleapis.com/css?family=Arimo:400,700,400italic|Oxygen' rel='stylesheet' type='text/css'>
<link href='https://fonts.googleapis.com/css?family=Inconsolata:400,700' rel='stylesheet' type='text/css'>
<link rel="apple-touch-icon-precomposed" href="somepath/image.png" />
<link rel="StyleSheet" href="https://www.airmanopus.net/drivinandflyin/iphone.css" type="text/css">

<script src='https://api.tiles.mapbox.com/mapbox.js/v1.6.4/mapbox.js'></script>
<link href='https://api.tiles.mapbox.com/mapbox.js/v1.6.4/mapbox.css' rel='stylesheet' />
<script src='https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-osm/v0.1.0/leaflet-osm.js'></script>
<script type="text/javascript">  

function CSVToArray( strData, strDelimiter )
{

	// CSVToArray (c) ben nadel
        // http://www.bennadel.com/blog/1504-ask-ben-parsing-csv-strings-with-javascript-exec-regular-expression-command.htm
        //
        // This will parse a delimited string into an array of
        // arrays. The default delimiter is the comma, but this
        // can be overriden in the second argument.
        // Check to see if the delimiter is defined. If not,
        // then default to comma.
        strDelimiter = (strDelimiter || ",");

        // Create a regular expression to parse the CSV values.
        var objPattern = new RegExp(
        (
        // Delimiters.
        "(\\" + strDelimiter + "|\\r?\\n|\\r|^)" +

        // Quoted fields.
        "(?:\"([^\"]*(?:\"\"[^\"]*)*)\"|" +

        // Standard fields.
        "([^\"\\" + strDelimiter + "\\r\\n]*))"
        ),
        "gi"
        );

        // Create an array to hold our data. Give the array
        // a default empty first row.
        var arrData = [[]];

        // Create an array to hold our individual pattern
        // matching groups.
        var arrMatches = null;


        // Keep looping over the regular expression matches
        // until we can no longer find a match.
        while (arrMatches = objPattern.exec( strData )){

        // Get the delimiter that was found.
        var strMatchedDelimiter = arrMatches[ 1 ];

        // Check to see if the given delimiter has a length
        // (is not the start of string) and if it matches
        // field delimiter. If id does not, then we know
        // that this delimiter is a row delimiter.
        if (
        strMatchedDelimiter.length &&
        (strMatchedDelimiter != strDelimiter)
        ){

        // Since we have reached a new row of data,
        // add an empty row to our data array.
        arrData.push( [] );

        }


        // Now that we have our delimiter out of the way,
        // let's check to see which kind of value we
        // captured (quoted or unquoted).

   if (arrMatches[ 2 ]){

        // We found a quoted value. When we capture
        // this value, unescape any double quotes.
        var strMatchedValue = arrMatches[ 2 ].replace(
        new RegExp( "\"\"", "g" ),
        "\""
        );

        } else {

        // We found a non-quoted value.
        var strMatchedValue = arrMatches[ 3 ];
         // We found a non-quoted value.
        var strMatchedValue = arrMatches[ 3 ];

        }


        // Now that we have our value string, let's add
        // it to the data array.
        arrData[ arrData.length - 1 ].push( strMatchedValue );
        }

        // Return the parsed data.
        return( arrData );
}

function geoError()
{
        document.write("<span class='errorText'>Geolocation failed. You may need to enable location services on your device.</span>");
}

function updateWeather() 
{

        // get current weather conditions 
	var weatherLat = arguments[0];
    	var weatherLon = arguments[1];
	var weatherGetURL = "https://api.worldweatheronline.com/free/v1/weather.ashx?q=" + weatherLat + "%2C" + weatherLon + "&format=json&extra=localObsTime%2CisDayTime&num_of_days=1&date=tomorrow&includelocation=yes&key=kc2u593rw3h5bp2pga7fs7ut";
        var weatherGet = new XMLHttpRequest();
        weatherGet.open('GET',weatherGetURL,false);
        weatherGet.send();
	
        var weatherResponse = JSON.parse(weatherGet.responseText);
        var weatherDesc = weatherResponse.data.current_condition[0].weatherDesc[0].value;
        var temp_F = weatherResponse.data.current_condition[0].temp_F;
        var visibility = weatherResponse.data.current_condition[0].visibility;
        var humidity = weatherResponse.data.current_condition[0].humidity;   
        var precipMM = weatherResponse.data.current_condition[0].precipMM;
        var windSpeed = weatherResponse.data.weather[0].windspeedMiles;
        var windDir = weatherResponse.data.weather[0].winddirection;
        var obsTime = weatherResponse.data.current_condition[0].localObsDateTime;
        var city = weatherResponse.data.nearest_area[0].areaName[0].value;
        var state = weatherResponse.data.nearest_area[0].region[0].value;


        // calculate heat index and wind chill
        var tempSquared = temp_F * temp_F;
        var relHSquared = humidity * humidity;
        var heatIndex = Math.round(-42.379 + (2.04901523 * temp_F) + (10.14333127 * humidity) - (0.22475541 * temp_F * humidity) - ( .00683783 * tempSquared) - (.05481717 * relHSquared) + ( .00122874 * tempSquared * humidity) + (.00085282 * temp_F * relHSquared) - (.00000199 * tempSquared * relHSquared));
        var windChill = Math.round(35.74 + (0.6215 * temp_F) - (35.75 * Math.pow(windSpeed,0.16)) + (0.4275 * temp_F * Math.pow(windSpeed,0.16)));

        // TODO re add one line short term forecast 
        
        var weatherIconURL = weatherResponse.data.weather[0].weatherIconURL;
        var weatherInfoURL = weatherResponse.data.weather[0].weatherURL;
        
        localWeather.innerHTML = ""; // clear last observation data
        localWeather.innerHTML += city + ", " + state + "<br>";
        localWeather.innerHTML += lat.toPrecision(9) + "," + lon.toPrecision(9) + "<br>";
        localWeather.innerHTML += weatherDesc + " and " + temp_F + "\xB0" + "F<br>";
		localWeather.innerHTML += "Humidity " + humidity + "% Visibility " + visibility + " mi<br>";
        localWeather.innerHTML += "Wind " + windDir + " at " + windSpeed + "mph<br>";
        if (temp_F < 45)
        {
                getElementById("localWeather").innerHTML += "Wind Chill " + windChill + "\xB0" + "F<br>";
        }
        if (temp_F > 70)
        {
                localWeather.innerHTML += "Heat Index " + heatIndex + "\xB0" + "F<br>";
        }
        localWeather.innerHTML += (precipMM>0.0)?"Precip (mm) "+ precipMM + "<br>":"Precip none<br>";
        localWeather.innerHTML += "Observation time " + obsTime + "<br>";

}

function formatDate()
{
	var incomingDate = arguments[0];
	// we get 2014-08-05T13:03:00.000, we want 13:03
	var shortDate = incomingDate.substring(12,16);
	return shortDate;
}

function updateDeparturesFids()
{
	// display data from Flight Information Data System(FIDS) API
	// see https://developer.flightstats.com/api-docs/fids/v1/fidsResponse
	console.log("entering updateDeparturesFids");
	var airportIATA = arguments[0];
	var departuresFidsGetURL = "https://www.airmanopus.net/cgi-bin/flightStats.cgi?https://api.flightstats.com/flex/fids/rest/v1/json/" + airportIATA + "/departures?appId=03ac1ffa&appKey=0505f46298d4dc8c52468a3338aa7453&requestedFields=airlineLogoUrlPng%2CairlineName%2CairlineCode%2CflightNumber%2Ccity%2CcurrentTime%2Cgate%2Cterminal%2CstatusCode%2CremarksCode%2CremarksWithTime%2Cweather%2CtemperatureC%2CtemperatureF&sortFields=currentTime&includeCodeshares=true&timeFormat=24&lateMinutes=15&boardingMinutes=30&useRunwayTimes=true&excludeCargoOnlyFlights=true&timeWindowEnd=240"
        var departuresFidsGet = new XMLHttpRequest();
        departuresFidsGet.open('GET',departuresFidsGetURL,false);
        departuresFidsGet.send();
	document.getElementById("departuresFids").innerHTML = "<span class='fidsDisplay'>Departures</span><br><br>";
	var departuresFidsGetJSON = JSON.parse(departuresFidsGet.responseText);
	for (x = 0; x < departuresFidsGetJSON.fidsData.length; x++)
	{
		document.getElementById("departuresFids").innerHTML += "<p class='fidsDisplay'>";
		// make sure we are getting the https version of the airline logo
		var airlineLogoURLPngInsecure = departuresFidsGetJSON.fidsData[x].airlineLogoUrlPng;
		var airlineLogoURLPngSecure = airlineLogoURLPngInsecure.replace("http","https");
		document.getElementById("departuresFids").innerHTML += "<img src='" + airlineLogoURLPngSecure + "' width=50 height=15 alt='" + departuresFidsGetJSON.fidsData[x].airlineName +"'> " ;
		document.getElementById("departuresFids").innerHTML += " " + departuresFidsGetJSON.fidsData[x].airlineName;
		document.getElementById("departuresFids").innerHTML += " " + departuresFidsGetJSON.fidsData[x].airlineCode + " " + departuresFidsGetJSON.fidsData[x].flightNumber;
		document.getElementById("departuresFids").innerHTML += " leaving for " + departuresFidsGetJSON.fidsData[x].city + " (" + departuresFidsGetJSON.fidsData[x].weather + " " +  departuresFidsGetJSON.fidsData[x].temperatureF + "\xB0/" +  departuresFidsGetJSON.fidsData[x].temperatureC + "\xB0)";
		if (departuresFidsGetJSON.fidsData[x].gate != undefined) 
		{
			document.getElementById("departuresFids").innerHTML += " from Gate " + departuresFidsGetJSON.fidsData[x].gate + " ";
		}
		if (departuresFidsGetJSON.fidsData[x].terminal != undefined)
		{
			document.getElementById("departuresFids").innerHTML += " Terminal " + departuresFidsGetJSON.fidsData[x].terminal + " ";
		}
		document.getElementById("departuresFids").innerHTML += " at " + departuresFidsGetJSON.fidsData[x].currentTime;

		// if the flight is on time, display green. any other status display red
		var isOnTime = departuresFidsGetJSON.fidsData[x].remarksWithTime.search("On-Time");
		if (isOnTime == -1)
		{ 
			document.getElementById("departuresFids").innerHTML += " <span style='background-color:red;color:white;'>" + departuresFidsGetJSON.fidsData[x].remarksWithTime + "</span>";
		} else {
			 document.getElementById("departuresFids").innerHTML += " <span style='background-color:green;color:white;'>" + departuresFidsGetJSON.fidsData[x].remarksWithTime + "</span>";
		}
		document.getElementById("departuresFids").innerHTML += "</p>";

	}
console.log("leaving updateDeparturesFids");
	
}

function updateArrivalsFids()
{
        // display data from Flight Information Data System(FIDS) API
        // see https://developer.flightstats.com/api-docs/fids/v1/fidsResponse
        console.log("entering updateArrivalsFids");
        var airportIATA = arguments[0];
        var arrivalsFidsGetURL = "https://www.airmanopus.net/cgi-bin/flightStats.cgi?https://api.flightstats.com/flex/fids/rest/v1/json/" + airportIATA + "/arrivals?appId=03ac1ffa&appKey=0505f46298d4dc8c52468a3338aa7453&requestedFields=airlineLogoUrlPng%2CairlineName%2CairlineCode%2CflightNumber%2Ccity%2CcurrentTime%2Cgate%2Cterminal%2CstatusCode%2CremarksCode%2CremarksWithTime%2Cweather%2CtemperatureC%2CtemperatureF%2Cbaggage&sortFields=currentTime&includeCodeshares=true&timeFormat=24&timeWindowEnd=240&lateMinutes=15&boardingMinutes=30&useRunwayTimes=true&excludeCargoOnlyFlights=true";
        var arrivalsFidsGet = new XMLHttpRequest();
        arrivalsFidsGet.open('GET',arrivalsFidsGetURL,false);
        arrivalsFidsGet.send();
	document.getElementById("arrivalsFids").innerHTML = "<span class='fidsDisplay'>Arrivals</span><br><br>";
	var arrivalsFidsGetJSON = JSON.parse(arrivalsFidsGet.responseText);
	for (x = 0; x < arrivalsFidsGetJSON.fidsData.length; x++)
	{
		// make sure we are getting the https version of the airline logo
                var airlineLogoURLPngInsecure = arrivalsFidsGetJSON.fidsData[x].airlineLogoUrlPng;
                var airlineLogoURLPngSecure = airlineLogoURLPngInsecure.replace("http","https");

		document.getElementById("arrivalsFids").innerHTML += "<p class='fidsDisplay'>";
		document.getElementById("arrivalsFids").innerHTML += "<img src='" + airlineLogoURLPngSecure + "' width=50 height=15 alt='" + arrivalsFidsGetJSON.fidsData[x].airlineName +"'> " +  arrivalsFidsGetJSON.fidsData[x].airlineName;
		document.getElementById("arrivalsFids").innerHTML += " " + arrivalsFidsGetJSON.fidsData[x].airlineCode + " " + arrivalsFidsGetJSON.fidsData[x].flightNumber;
		document.getElementById("arrivalsFids").innerHTML += " arriving from " + arrivalsFidsGetJSON.fidsData[x].city + " (" + arrivalsFidsGetJSON.fidsData[x].weather + " " +  arrivalsFidsGetJSON.fidsData[x].temperatureF + "\xB0/" +  arrivalsFidsGetJSON.fidsData[x].temperatureC + "\xB0)";

		// only display these fields if they actually have values
		if (arrivalsFidsGetJSON.fidsData[x].gate != undefined) 
		{
			document.getElementById("arrivalsFids").innerHTML += " Gate " + arrivalsFidsGetJSON.fidsData[x].gate + " ";
		}
		if (arrivalsFidsGetJSON.fidsData[x].terminal != undefined)
		{
			document.getElementById("arrivalsFids").innerHTML += " Terminal " + arrivalsFidsGetJSON.fidsData[x].terminal + " ";
		}
		if (arrivalsFidsGetJSON.fidsData[x].baggage != undefined)
                {
                        document.getElementById("arrivalsFids").innerHTML += " Baggage Carousel  " + arrivalsFidsGetJSON.fidsData[x].baggage + " ";
		}
	
		// if the flight is on time, display green. any other status display red
		var isOnTime = arrivalsFidsGetJSON.fidsData[x].remarksWithTime.search("On-Time");
		if (isOnTime == -1)
	        { 
				document.getElementById("arrivalsFids").innerHTML += " <span style='background-color:red;color:white;'>" + departuresFidsGetJSON.fidsData[x].remarksWithTime + "</span>";
		} else {
				 document.getElementById("arrivalsFids").innerHTML += " <span style='background-color:green;color:white;'>" + departuresFidsGetJSON.fidsData[x].remarksWithTime + "</span>";
		}
		document.getElementById("arrivalsFids").innerHTML += "</p>";
	}

console.log("leaving updateArrivalsFids");

}


function updateArrivals()
{
	console.log("entering updateArrivals");
	var airportIATA = arguments[0];
	var q = new Date();              	// current date to use for requesting flight data for an airport
    	var arrivalsyear = q.getFullYear();     // current year
    	var arrivalsmonth = q.getMonth()+1;     // current month
    	var arrivalsday = q.getDate();          // current day
    	var arrivalshour = q.getHours();
    	const NUM_HOURS_TO_INCLUDE = 3;
	var arrivingFlightsGetVerify = true;
	var arrivingFlightsGet = new XMLHttpRequest();
	var arrivingFlightsURL = "https://api.flightstats.com/flex/flightstatus/rest/v2/json/airport/status/" + airportIATA + "/arr/" + arrivalsyear + "/" + arrivalsmonth + "/" + arrivalsday + "/" + arrivalshour + "?appId=03ac1ffa&appKey=0505f46298d4dc8c52468a3338aa7453&utc=false&numHours=" + NUM_HOURS_TO_INCLUDE + "&maxFlights=5&extendedOptions=useInlinedReferences";
	
	var arrivingFlightsProcess="https://www.airmanopus.net/cgi-bin/arrivals.cgi?" + arrivingFlightsURL;
	arrivingFlightsGet.open('GET', arrivingFlightsProcess, false);
	arrivingFlightsGet.send();
	// make sure we received data instead of an error (or no data)
	 try
	 {      
		 var arrivingFlightsJSON = JSON.parse(arrivingFlightsGet.responseText);
	 }

	 catch(err)
	 {
		 document.getElementById("airportArrivals").innerHTML += "There are no flights scheduled to arrive during the next " + numHourstoInclude + " hours.<br>";
		 arrivingFlightsGetVerify = false;
	 }
	 if (arrivingFlightsGetVerify == true)
	 {
		if (arrivingFlightsJSON.flightStatuses.length > 0)
		{
			// there is at least one arriving flight to display

			for (var i=0; i < arrivingFlightsJSON.flightStatuses.length;i++) 
			{
				// we are only interested in scheduled passenger (normal service) flights
				try 
				{
					// if no flight type its not scheduled passenger flight
					var flightType = arrivingFlightsJSON.flightStatuses[i].schedule.flightType;
				}

				catch(err)
				{
					// setting the flightType to empty will correctly cause the if flightType test to fail
					var flightType = "";
				}

				if (flightType == "J")
				{

					// arrivingFlightsJSON.flightStatuses[i].status

					// display arrivals here
					document.getElementById("airportArrivals").innerHTML =
					"<br><br><b>" + arrivingFlightStatus.carrierName + " " + arrivingFlightStatus.flightNumber + "</b> departed " 
									 + formatDate(arrivingFlightsJSON.flightStatuses[i].departureDate.dateLocal) 
									 + " from " + arrivingFlightStatus.departureAirportCity  
									 + " (" + arrivingFlightStatus.departureAirportIATA + ")" 
                                                                         + " arriving at " + arrivingFlightStatus.arrivalAirportCity
									 + " (" + arrivingFlightsJSON.flightStatuses[i].arrivalAirport.iata
									 + ") at " + formatDate(arrivingFlightsJSON.flightStatuses[i].arrivalDate.dateLocal)
									 + "<br>";
					try 
					{
						document.getElementById("airportArrivals").innerHTML +=  "Gate " + arrivingFlightsJSON.flightStatuses[i].airportResources.arrivalGate;
						 
						if (arrivingFlightsJSON.flightStatuses[i].airportResources.arrivalTerminal != undefined)
						{	
							document.getElementById("airportArrivals").innerHTML +=  " Terminal " +  arrivingFlightsJSON.flightStatuses[i].airportResources.arrivalTerminal;
						}
						if (arrivingFlightsJSON.flightStatuses[i].airportResources.baggage != undefined)
						{
							document.getElementById("airportArrivals").innerHTML +=	" Baggage " + arrivingFlightsJSON.flightStatuses[i].airportResources.baggage + "<br>";
						}
					}
					catch(err)
					{
						document.getElementById("airportArrivals").innerHTML += "No gate/terminal info available. Check screens at airport.";
					}
				
				} // if we dont do anything with a flight that is not a passenger flight
			} 
		} // if
	} // if 
	console.log("leaving updateArrivals");
}	


function updateArrivalsTracks()
{
// now display the tracks for each flight we are tracking
// if there were no arriving flights listed we should skip looking for tracks once this is all working


	var arrivingPlanesGet = new XMLHttpRequest();
	var arrivingPlanesURL = "https://api.flightstats.com/flex/flightstatus/rest/v2/json/airport/tracks/" + airportIATA + "/arr?appId=03ac1ffa&appKey=0505f46298d4dc8c52468a3338aa7453&includeFlightPlan=false&maxPositions=2&maxPositionAgeMinutes=15&extendedOptions=useInlinedReferences";
	var arrivingPlanesProcess="https://www.airmanopus.net/cgi-bin/arrivals.cgi?" + arrivingPlanesURL;
	arrivingPlanesGet.open('GET',arrivingPlanesProcess,false);
	arrivingPlanesGet.send();
	var arrivingPlaneStatusJSON = JSON.parse(arrivingPlanesGet.responseText);
	
	if (arrivingPlaneStatusJSON.flightTracks.length != 0)
	{	
		for (var i=0; i < arrivingPlaneStatusJSON.length; i++)
		{
			var arrivingAirplaneStatus = {
				arrivingFlightID        : arrivingPlaneStatusJSON[i].flightID,
				departingAirport        : arrivingPlaneStatusJSON[i].departureAirport.iata,
				departingCity		: arrivingPlaneStatusJSON[i].departureAirport.city,
				arrivingairport         : arrivingPlaneStatusJSON[i].arrivalAirport.iata,
				arrivingCity		: arrivingPlaneStatusJSON[i].arrivalAirport.city,
				carrierName		: arrivingPlaneStatusJSON[i].carrier.name,
				carrierICAO		: arrivingPlaneStatusJSON[i].carrier.icao,
				flightNumber		: arrivingPlaneStatusJSON[i].flightNumber,
				tailNumber		: arrivingPlaneStatusJSON[i].tailNumber,
				equipment		: arrivingPlaneStatusJSON[i].equipment,
				heading			: arrivingPlaneStatusJSON[i].heading,
				
				position0Date		: arrivingPlaneStatusJSON[i].positions[0].date,
				position0lat		: arrivingPlaneStatusJSON[i].positions[0].lat,			
				position0lon            : arrivingPlaneStatusJSON[i].positions[0].lon,
				position0speed		: arrivingPlaneStatusJSON[i].positions[0].speed,

				position1Date           : arrivingPlaneStatusJSON[i].positions[1].date,
                                position1lat            : arrivingPlaneStatusJSON[i].positions[1].lat,
                                position1lon            : arrivingPlaneStatusJSON[i].positions[1].lon,
                                position1speed          : arrivingPlaneStatusJSON[i].positions[1].speed,
				position1altitude	: arrivingPlaneStatusJSON[i].positions[1].altitude,
			}; // arrivingAirplaneStatus

			// display status info line fer this flight	here
			// for now just display using text
			// TODO make these markers on the map
		}
	} else {
		document.getElementById("airportArrivalsTracks").innerHTML = "<p>No tracks available for arrivals at " + airportIATA + ".</p>";	
	}
}	





function metersToMiles()
{
	var meters = arguments[0];
	miles = (meters * .000621371).toFixed(2);
	return miles;
}

function secToMin()
{
	var seconds = arguments[0];
	var minutes = seconds / 60;
	return minutes;
}

function minToHours()
{
	var minutes = arguments[0];
	var hours = minutes / 60;
	return hours;
}


function updateTraffic()
{
	// lat,lon is the coordinates of the passenger terminal
	var lat = arguments[0];
    	var lon = arguments[1];
	var airportLat = arguments[2];
	var airportLon = arguments[3];
	var airportIATA = arguments[4];
	// check traffic to get estimate on when will we get to the airport 
	// we always display driving  ETA from our location to each airport

	var MILES_PER_METER = .000621371;

	var airportETAGet = new XMLHttpRequest();
	var airportETAURL="https://api.tomtom.com/lbs/services/route/3/" + lat + "," + lon + ":" + airportLat + "," + airportLon + "/Quickest/json?avoidTraffic=true&includeTraffic=true&day=today&iqRoutes=2&includeInstructions=true&key=knpmsu5p59rxdud2rmghsxd7"
	var airportETAProcess="https://www.airmanopus.net/cgi-bin/tomtom.cgi?" + airportETAURL;
	airportETAGet.open('GET', airportETAProcess, false);
	airportETAGet.send();
	var airportRoute=JSON.parse(airportETAGet.responseText);
	var airportETA = airportRoute.route.summary.arrivalOverview.time;
	var distanceMeters = airportRoute.route.summary.totalDistanceMeters; 
	var distanceMiles = distanceMeters * MILES_PER_METER;
	if (airportIATA != null)
	{
		document.getElementById("traffic").innerHTML += "<br>" + airportIATA + " is approx " + distanceMiles.toFixed(2) + " miles away. <br> Your estimated arrival time at " + airportIATA + " is " + airportETA + ".<br>";
	}	
	// display driving directions to a chosen airport
	for (var p=0; p < airportRoute.route.instructions.instruction.length; p++)
        {
             	// each p is one instruction 

		var iconURL = "https://www.airmanopus.net/drivinandflyin/tomtom/RoutingIcons/" + airportRoute.route.instructions.instruction[p].iconPath;
                document.getElementById("traffic").innerHTML += "<img src='" + iconURL + "' alt='" + airportRoute.route.instructions.instruction[p].text + "'>";
		document.getElementById("traffic").innerHTML += airportRoute.route.instructions.instruction[p].text + " " + airportRoute.route.instructions.instruction[p].roadName;
		document.getElementById("traffic").innerHTML += " Distance " + metersToMiles(airportRoute.route.instructions.instruction[p].distanceMeters) + "mi.";
		var travelTimeSeconds = airportRoute.route.instructions.instruction[p].travelTimeSeconds;
		var travelTimeMinutes = secToMin(travelTimeSeconds);
		var travelTimeHours = minToHours(travelTimeMinutes);
		if (travelTimeHours > 1)
		{
			document.getElementById("traffic").innerHTML += " Travel time " + travelTimeHours.toFixed(2) + " hours<br>";
		} else if (travelTimeMinutes > 1) {
			 document.getElementById("traffic").innerHTML += " Travel time " + travelTimeMinutes.toFixed(2) + " minutes<br>";
		} else {
			document.getElementById("traffic").innerHTML += " Travel time " + travelTimeSeconds.toFixed(2) + " seconds<br>";

		}

	}
}

function updateDelays()
{
	var iataIdentifier = arguments[0];
	// see if this airport has a delay or closure notice posted
	var airportStatusURL="https://www.airmanopus.net/cgi-bin/airports.cgi?iata=" + iataIdentifier;
	var airportStatusGet = new XMLHttpRequest();
	airportStatusGet.open('GET',airportStatusURL,false); 
	airportStatusGet.send();
	var airportStatusResponse = airportStatusGet.responseText;
	// if we see a less than chr we didnt get a json response so no delays
	// probably a smaller airport that FAA doesnt keep status on
	// we always display the delay text
	if ( airportStatusResponse.charAt(0) != "<" )
	{
		var airportStatus = JSON.parse(airportStatusGet.responseText);
		var airportIATA = airportStatus.IATA;
		var airportName = airportStatus.name;
		var delayStatus = airportStatus.delay;
		var airportDelayReason = airportStatus.status.reason;
		var airportClosureBegin = airportStatus.status.closureBegin;
		var airportClosureEnd = airportStatus.status.closureEnd;
		var airportMinDelay = airportStatus.status.MinDelay;
		var airportMaxDelay = airportStatus.status.MaxDelay;
		var airportAvgDelay = airportStatus.status.AvgDelay;
		
		// name and IATA always display if within viewPortdistance 	
		
		document.getElementById("airportDelays").innerHTML += "<br>" + airportName + " (" + airportIATA + ")<br>";
		document.getElementById("airportDelays").innerHTML += airportDelayReason + "<br>";
		// display closure info only if airport is closed 
		if ( airportClosureBegin != "")
		{
			 document.getElementById("airportsDelaysText").innerHTML +=  "<br>" + airportName + "(" + airportIATA + ")" + " closed from " + airportClosureBegin + " to " + airportClosureEnd;
		} 

		// display delay reason only when there is a delay
		if  (delayStatus != "false")
		{
			// display delay times only if we received them
			if (airportMinDelay != null)
			{
			document.getElementById("airportsDelays").innerHTML += "<br>Min " + airportMinDelay + " Max " + airportMaxDelay + " Avg " + airportAvgDelay;
			}
		}
	} 
}

function updateDepartures()
{
	console.log("entering updateDepartures");
	var airportIATA = arguments[0];
	var d = new Date();
	var year = d.getFullYear();		// current year
	var month = d.getMonth() + 1;		// current month
	var day = d.getDate();			// current day
	var hour = d.getHours();		
	const NUM_HOURS_TO_INCLUDE = 3;
	var departingFlightsGetVerify = true;
	var departingFlightsGet = new XMLHttpRequest();
	var departingFlightsURL="https://www.airmanopus.net/cgi-bin/departures.cgi?https://api.flightstats.com/flex/flightstatus/rest/v2/json/airport/status/" + airportIATA + "/dep/" + year + "/" + month + "/" + day + "/" + hour + "?appId=03ac1ffa&appKey=0505f46298d4dc8c52468a3338aa7453&utc=false&numHours=" + NUM_HOURS_TO_INCLUDE + "&extendedOptions=useInlinedReferences";
	departingFlightsGet.open('GET', departingFlightsURL, false);
	departingFlightsGet.send();
	try
	{
        	// if this doesnt work we did not get valid departures data
		var departingFlightsJSON = JSON.parse(departingFlightsGet.responseText);
	}
	catch(err)
	{
		console.log(err);
		departingFlightsGetVerify = false;
	}

	// check information for each departing flight from this particular airport
	if (departingFlightsJSON.flightStatuses.length > 0) 
	{
		document.getElementById("airportDepartures").innerHTML = "";
		document.getElementById("airportDepartures").innerHTML = "<br>Departures<br><br>";

		if (departingFlightsGetVerify == true)
		{
			for ( k = 0; k < departingFlightsJSON.flightStatuses.length; k++ )
			{
		
				if (departingFlightsJSON.status == "J")
				{
					try
					{
						   // if no flight type its not scheduled passenger flight
						    var flightType = departingFlightsJSON.flightStatuses[k].schedule.flightType;
					}
	     
					catch(err)
					{
						// setting the flightType to empty will correctly cause the if flightType test to fail
						var flightType = "";
					}

				       if (flightType == "J")
				       {

						//status                          : departingFlightsJSON.flightStatuses[k].status

						document.getElementById("airportDepartures").innerHTML +=  "<br><br><b>" + departingFlightsJSON.flightStatuses[k].carrier.name; 
						document.getElementById("airportDepartures").innerHTML += " "  + departingFlightsJSON.flightStatuses[k].flightNumber + "</b> ";
						document.getElementById("airportDepartures").innerHTML += " departs at " + formatDate(departingFlightsJSON.flightStatuses[k].departureDate.dateLocal);
						if (departingFlightsJSON.flightStatuses[k].airportResources.departureGate != undefined)
						{
							document.getElementById("airportDepartures").innerHTML += " from gate " + departingFlightsJSON.flightStatuses[k].airportResources.departureGate; 
						}
						document.getElementById("airportDepartures").innerHTML += " to " + departingFlightsJSON.flightStatuses[k].arrivalAirport.city;
						document.getElementById("airportDepartures").innerHTML += " (" + departingFlightsJSON.flightStatuses[k].arrivalAirport.iata + ")<br>";
				}
			}
		}
	}
   }	
}

function updateDeparturesTracks()
{				
			// flight track information for a specific flight that is departing from an airport we are tracking
			// and is within the radius of the area we are tracking and is on our list of departures 
			// (The MD80 I am riding is headed WSW at 350MPH at an altitude of 35000 feet, at specific lat/lon)
			// a track is a line vector drawn between the most recent two reported positions on a map
			var departingPlaneStatusGet = new XMLHttpRequest();
			var departingPlaneStatusURL="https://api.flightstats.com/flex/flightstatus/rest/v2/json/airport/tracks/" + airportIATA + "/arr?appId=03ac1ffa&appKey=0505f46298d4dc8c52468a3338aa7453&includeFlightPlan=false&maxPositions=2&maxPositionAgeMinutes=15&extendedOptions=useInlinedReferences";
			var departingPlaneStatusProcess = "https://www.airmanopus.net/cgi-bin/departures.cgi?" + departingPlaneStatusURL;
			departingPlaneStatusGet.open('GET', departingPlaneStatusProcess, false);
			departingPlaneStatusGet.send();
			var departingPlaneStatusJSON = JSON.parse(departingPlaneStatusGet.responseText);
			for (var j=0; j < departingPlaneStatusJSON.flightTracks.length; j++)
			{
				var departingAirplaneStatus = {
					departingFlightID 	: departingPlaneStatusJSON.flightTracks[j].flightID,
					departingAirport 	: departingPlaneStatusJSON.flightTracks[j].departureAirport.iata,
					arrivingairport 	: departingPlaneStatusJSON.flightTracks[j].arrivalAirport.iata,
					depAirplaneBearing	: departingPlaneStatusJSON.flightTracks[j].bearing,
					depAirplaneHeading	: departingPlaneStatusJSON.flightTracks[j].heading,

					departingAirplaneLon0	: departingPlaneStatusJSON.flightTracks[j].positions[0].lon,			
					departingAirplaneLat0	: departingPlaneStatusJSON.flightTracks[j].positions[0].lat,
					departingAirplaneSpeed0	: departingPlaneStatusJSON.flightTracks[j].positions[0].speedMPH,
					departingAirplaneAlt0	: departingPlaneStatusJSON.flightTracks[j].positions[0].altitudeFt,
					departingAirplaneSource0 : departingPlaneStatusJSON.flightTracks[j].positions[0].source,
					departingAirplaneDate0	: departingPlaneStatusJSON.flightTracks[j].positions[0].date,
					
					departingAirplaneLon1   : departingPlaneStatusJSON.flightTracks[j].positions[1].lon,
					departingAirplaneLat1   : departingPlaneStatusJSON.flightTracks[j].positions[1].lat,
					departingAirplaneSpeed1 : departingPlaneStatusJSON.flightTracks[j].positions[1].speedMPH,
					departingAirplaneAlt1   : departingPlaneStatusJSON.flightTracks[j].positions[1].altitudeFt,
					departingAirplaneSource1 : departingPlaneStatusJSON.flightTracks[j].positions[1].source,
					departingAirplaneDate1  : departingPlaneStatusJSON.flightTracks[j].positions[1].date

				}; // departingAirplaneStatus
			} 
}

function airportNameToIATA()
{
	// TODO
	console.log("entering airportNameToIATA");
	var airportName = arguments[0];

	console.log("leaving airportNameToIATA");
}


function updateAirports() 
{
	console.log("entering updateAirports");
 	var lat = arguments[0];
	var lon = arguments[1];

	const PI = 3.14159265359;		// pi
	const R = 3959;			 	// approximate radius of earth in miles
	const METERS_TO_MILES = 1609.344;	// meters in one mile
	const NUM_HOURS_FLIGHTS = 5;		// get arr and dep flights fer this many hours from now

	flightStatusCodes = {
		'A' : 'active',
		'C' : 'canceled',
		'D' : 'diverted',
		'L' : 'landed',
		'R' : 'redirected',
		'S' : 'scheduled'
	};
	
	var viewportDistance = 81;		// watch airports fer delays within this many km (50 mi)
	var zoomedViewportDistance = 48; 	// within this many km of an airport get detailed flight info (30 mi)
	
	var nearbyAirportsGet = new XMLHttpRequest();
        var nearbyAirportsURL = "https://api.tomtom.com/places/search/1/place?format=json&lat=" + lat + "&lng=" + lon + "&what=airport&distance=" + viewportDistance + "&results=3&sort=distance&key=tbgsdr6fz7af2b6ghshk4tr3";
        var nearbyAirportsProcess = "https://www.airmanopus.net/cgi-bin/departures.cgi?" + nearbyAirportsURL;
        var nearbyAirportsGet.open('GET', nearbyAirportsProcess, false);
        var nearbyAirportsGet.send();
        var nearbyAirportsJSON = JSON.parse(nearbyAirportsGet.responseText);

	for (var j = 0; j < nearbyAirportsJSON.length; j++)
    	{
		var airportName = nearbyAirportsJSON.data.places.place[j].name;
		var airportDistance = nearbyAirportsJSON.data.places.place[j].distance;
		var airportCity = nearbyAirportsJSON.data.places.place[j].city;
		var airportPhone = nearbyAirportsJSON.data.places.place[j].phone;
		var airportWebsite = nearbyAirportsJSON.data.places.place[j].website;
		var airportAddress = nearbyAirportsJSON.data.places.place[j].formattedAddress;
		var airportZIP = nearbyAirportsJSON.data.places.place[j].zipcode;
		var airportLat = nearbyAirportsJSON.data.places.place[j].latitude;
		var airportLon = nearbyAirportsJSON.data.places.place[j].longitude;

		
		// TODO given an airport name we need its IATA code
		
		// km
		if (distance < viewportDistance)
		{       // we dont know which airport is your destination yet
			// so we just give you traffic info to airports you might be headed towards
			updateTraffic(lat,lon,airportLat,airportLon,iataIdentifier);	
		}
		
		if (distance < zoomedViewportDistance)
		{
				/* you are probably heading to one of the airports within this range
				   so we start telling you about delays at nearby airports and start
				   showing you flight information for departing and arriving flights
				   if you are going to an airport that isn't in range yet you'l
				   start seeing updates as soon as you are in range
				*/
				updateDelays(iataIdentifier,distance);
				updateDeparturesFids(iataIdentifier);
				updateArrivalsFids(iataIdentifier);
				//updateArrivals(iataIdentifier);
				//updateDepartures(iataIdentifier);
		} 
	
	
	}
	console.log("leaving updateAirports"); 
}


function clearEverything()
{
	document.getElementById("airportDepartures").innerHTML = "";
	document.getElementById("airportArrivals").innerHTML = "";
	document.getElementById("traffic").innerHTML = "";
	document.getElementById("airportDelays").innerHTML = "";
	document.getElementById("localWeather").innerHTML = "";
	
}




function initialize() {
	var map;
         if (navigator.geolocation) {
		var mapFirstDraw = true; // true until initial map is drawn, false thereafter
                navigator.geolocation.watchPosition(function(position){
			if (mapFirstDraw)
			{
				// init and draw the initial map
				lat = position.coords.latitude;
				lon = position.coords.longitude;
				// the map
				map = L.mapbox.map('map', 'airmanopus.hm9c0o4f', {
					center: [lat, lon],
					zoom: 14,
					inertia: true,
					watch: true,
					enableHighAccuracy: true,
					maximumAge: 25000,
					trackResize: true,
					attributionControl : true,
					setView : true,
				});
				mapFirstDraw = false;
				updateWeather(lat,lon);
				updateAirports(lat,lon);
			} else {
				// update map view to new location
				lat = position.coords.latitude;
				lon = position.coords.longitude;

				console.log(lat, lon);
				map.setView([lat, lon]);
				clearEverything();
				updateWeather(lat,lon);		
				updateAirports(lat,lon);
				console.log("back to initialize and waiting for location change");
            		}

		}); 
	} 
} 


</script>
<style>
html, body, #map {
	width: 100%;
	height: 65%;
	padding: 0;
	margin: 0;
}
</style>
</head>
<body onload="initialize()">
<div id="top-title"><img src="drivinandflyin.png" alt="Drivin' and Flyin'"></div>
<div id="map"></div>
<div id="motd" class="weatherDisplay">This is (barely) alpha software for now. Use at your own risk. A grue might eat you.<p></div>
<div id="localWeather" class="weatherDisplay"></div>
<div id="traffic" class="Inconsolata"></div>
<div id="airportDelays" class="Inconsolata"></div>
<div id="airportArrivals" class="Inconsolata"></div>
<!-- <div id="airportArrivalsTracks" class="Inconsolata"></div> -->
<div id="arrivalsFids"></div>
<div id="departuresFids"></div>
<div id="airportDepartures" class ="Inconsolata"></div>
<!-- <div id="airportDeparturesTracks" class="Inconsolata"></div> -->
<div id="footer">
<pre>
Weather powered by: <a href="https://www.worldweatheronline.com" target="_blank">World Weather Online</a>
Flight data &copy; <a href="https://developer.flightstats.com/" target="_blank">Flightstats</a>
Maps &copy;<a href="https://www.mapbox.com/" target="_blank">Mapbox</a> &copy;<a href="https://www.openstreetmap.org/" target="_blank">OpenStreetMap Contributors</a> 
Traffic data &copy;<a href="https://dev.tomtom.com" target="_blank">TomTom</a>
Remaining &copy; 2014 airmanopus
<a href="https://airmanopus.net/weathercheck/COPYING">COPYING</a> (GPLv3) <a href="https://www.airmanopus.net/weathercheck/privacy.html">Privacy</a> <a href="https://www.github.com/airmanopus/weathercheck">github</a>
</pre>
</div>



</html>

