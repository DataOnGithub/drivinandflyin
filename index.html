<!DOCTYPE HTML>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon-precomposed" href="somepath/image.png" />
<link href='https://fonts.googleapis.com/css?family=Droid+Sans+Mono' rel='stylesheet' type='text/css'>
<link rel="StyleSheet" href="https://www.airmanopus.net/weathercheck/iphone.css" type="text/css">

<script src='https://api.tiles.mapbox.com/mapbox.js/v1.6.2/mapbox.js'></script>
<link href='https://api.tiles.mapbox.com/mapbox.js/v1.6.2/mapbox.css' rel='stylesheet' />
<script src='https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-osm/v0.1.0/leaflet-osm.js'></script>

<script type="text/javascript">
	// CSVToArray (c) ben nadel
	// http://www.bennadel.com/blog/1504-ask-ben-parsing-csv-strings-with-javascript-exec-regular-expression-command.htm 
	// 
	// This will parse a delimited string into an array of
	// arrays. The default delimiter is the comma, but this
	// can be overriden in the second argument.
	function CSVToArray( strData, strDelimiter ){
	// Check to see if the delimiter is defined. If not,
	// then default to comma.
	strDelimiter = (strDelimiter || ",");
	 
	// Create a regular expression to parse the CSV values.
	var objPattern = new RegExp(
	(
	// Delimiters.
	"(\\" + strDelimiter + "|\\r?\\n|\\r|^)" +
	 
	// Quoted fields.
	"(?:\"([^\"]*(?:\"\"[^\"]*)*)\"|" +
	 
	// Standard fields.
	"([^\"\\" + strDelimiter + "\\r\\n]*))"
	),
	"gi"
	);
	 
	 
	// Create an array to hold our data. Give the array
	// a default empty first row.
	var arrData = [[]];
	 
	// Create an array to hold our individual pattern
	// matching groups.
	var arrMatches = null;
	 
	 
	// Keep looping over the regular expression matches
	// until we can no longer find a match.
	while (arrMatches = objPattern.exec( strData )){
	 
	// Get the delimiter that was found.
	var strMatchedDelimiter = arrMatches[ 1 ];
	 
	// Check to see if the given delimiter has a length
	// (is not the start of string) and if it matches
	// field delimiter. If id does not, then we know
	// that this delimiter is a row delimiter.
	if (
	strMatchedDelimiter.length &&
	(strMatchedDelimiter != strDelimiter)
	){
	 
	// Since we have reached a new row of data,
	// add an empty row to our data array.
	arrData.push( [] );
	 
	}
	 
	 
	// Now that we have our delimiter out of the way,
	// let's check to see which kind of value we
	// captured (quoted or unquoted).
	if (arrMatches[ 2 ]){
	 
	// We found a quoted value. When we capture
	// this value, unescape any double quotes.
	var strMatchedValue = arrMatches[ 2 ].replace(
	new RegExp( "\"\"", "g" ),
	"\""
	);
	 
	} else {
	 
	// We found a non-quoted value.
	var strMatchedValue = arrMatches[ 3 ];
	 
	}
	 
	 
	// Now that we have our value string, let's add
	// it to the data array.
	arrData[ arrData.length - 1 ].push( strMatchedValue );
	}
	 
	// Return the parsed data.
	return( arrData );
	}
 
	// end of bens code

	// start of mine


	var statesToAbbreviations = {
		'Alabama' 	: 'AL',
		'Alaska'  	: 'AK',
		'Arizona' 	: 'AZ',
		'Arkansas'	: 'AR',
		'California' 	: 'CA',
		'Colorado' 	: 'CO',
		'Connecticut' 	: 'CT',
		'Delaware' 	: 'DE',
		'District of Columia' : 'DC',
		'Florida' 	: 'FL',
		'Georgia' 	: 'GA',
		'Hawaii' 	: 'HI',
		'Idaho' 	: 'ID',
		'Illinois' 	: 'IL',
		'Indiana' 	: 'IN',
		'Iowa'		: 'IA',
		'Kansas' 	: 'KS',
		'Kentucky' 	: 'KY',
		'Louisiana' 	: 'LA',
		'Maine' 	: 'ME',
		'Maryland' 	: 'MD',
		'Massachusetts' : 'MA',
		'Michigan' 	: 'MI',
		'Minnesota' 	: 'MN',
		'Mississippi' 	: 'MS',
		'Missouri' 	: 'MO',
		'Montana' 	: 'MT',
		'Nebraska' 	: 'NE',
		'Nevada' 	: 'NV',
		'New Hampshire' : 'NH',
		'New Jersey' 	: 'NJ',
		'New Mexico' 	: 'NM',
		'New York' 	: 'NY',
		'North Carolina': 'NC',
		'North Dakota' 	: 'NC',
		'Ohio' 		: 'OH',
		'Oklahoma' 	: 'OK',
		'Oregon' 	: 'OR',
		'Pennsylvania'	: 'PA',
		'Rhode Island' 	: 'RI',
		'South Carolina': 'SC',
		'South Dakota' 	: 'SD',
		'Tennessee' 	: 'TN',
		'Texas' 	: 'TX',
		'Utah' 		: 'UT',
		'Vermont' 	: 'VT',
		'Virginia' 	: 'VA',
		'Washington'	: 'WA',
		'West Virginia' : 'WV',
		'Wisconsin' 	: 'WI',
		'Wyoming' 	: 'WY'
	};

	var usStates = {
		'AK': [' '],
		'AL': ['FL', 'GA', 'MS', 'TN'],
		'AR': ['LA', 'MO', 'MS', 'OK', 'TN', 'TX'],
		'AZ': ['CA', 'CO', 'NM', 'NV', 'UT'],
		'CA': ['NV', 'OR'], 
		'CO': ['KS', 'NE', 'NM', 'OK', 'UT', 'WY'],
		'CT': ['MA', 'NY', 'RI'],
		'DC': ['MD', 'VA'],
		'DE': ['MD', 'NJ', 'PA'],
		'FL': ['AL', 'GA'],
		'GA': ['NC', 'SC', 'TN', 'FL'],
		'HI': [' '],
		'IA': ['IL', 'MN', 'MO', 'NE', 'SD', 'WI'],
		'ID': ['MT', 'NV', 'OR', 'UT', 'WA', 'WY'],
		'IL': ['IN', 'KY', 'MO', 'WI'],
		'IN': ['KY', 'MI', 'OH'],
		'KS': ['CO', 'MO', 'NE', 'OK'],
		'KY': ['MO', 'OH', 'TN', 'VA', 'WV'],
		'LA': ['AR', 'MS', 'TX'],
		'MA': ['CT', 'NH', 'NY', 'RI', 'VT'],
		'MD': ['DC', 'PA', 'VA', 'WV'],
		'ME': ['NH'],
		'MI': ['IN', 'OH', 'WI'],
		'MN': ['IA', 'ND', 'SD', 'WI'],
		'MO': ['AR', 'IA', 'IL', 'KS', 'KY', 'NE', 'OK', 'TN'],
		'MS': ['LA', 'AR', 'TN', 'AL'],
		'MT': ['ID', 'ND', 'SD', 'NE', 'WY'],
		'NC': ['SC', 'TN', 'VA'],
		'ND': ['MN', 'SD', 'MT'],
		'NE': ['CO', 'IA', 'KS', 'MO', 'SD', 'WY'],
		'NH': ['VT', 'ME', 'MA'],
		'NJ': ['DE', 'PA', 'NY'],
		'NM': ['AZ', 'UT', 'CO', 'OK', 'TX'],
		'NV': ['CA', 'AZ', 'UT', 'ID', 'OR'],
		'NY': ['OH', 'MA', 'PA', 'CA'],
		'OH': ['IN', 'MI', 'PA', 'KY', 'WV'],
		'OK': ['AK', 'TX', 'NM', 'CO', 'KS', 'MO'],
		'OR': ['WA', 'ID', 'NV', 'CA'],
		'PA': ['OH', 'WV', 'MD', 'NJ', 'NY'],
		'RI': ['CT', 'MA', 'NY'],
		'SC': ['GA', 'NC'],
		'SD': ['ND', 'IA', 'NE', 'MN', 'MT', 'WY'],
		'TN': ['AK', 'MS', 'AL', 'GA', 'NC', 'VA', 'MO', 'AR'],
		'TX': ['NM', 'OK', 'AR', 'LA'],
		'UT': ['CO', 'NM', 'AZ', 'NV', 'ID', 'WY'],
		'VA': ['NC', 'KY', 'WV', 'MD'],
		'WA': ['ID', 'OR'],
		'WV': ['OH', 'PA', 'MD', 'KY'],
		'WI': ['IA', 'IL', 'MN', 'MI'],
		'WY': ['MT', 'SD', 'NE', 'CO', 'UT', 'ID']
	};
	

function geoError(){
        document.write("Geolocation failed. You may need to enable location services on your device.");
}


function initialize(){
         if (navigator.geolocation){
                navigator.geolocation.getCurrentPosition(function(position){
			lat = position.coords.latitude;
			lon = position.coords.longitude;

		// the map
		var map = L.mapbox.map('map', 'airmanopus.hm9c0o4f', {
			center: [lat, lon],
			zoom: 12,
			inertia: true,
			watch: true,
			enableHighAccuracy: true,
			maximumAge: 50000,
			trackResize: true,
			attributionControl : true
		});
		L.marker([lat, lon]).addTo(map);

		// next find the longname of the US state we are in so we can load the right radar images
		var reverseGeocodeURL = "https://api.tiles.mapbox.com/v3/airmanopus.hm9c0o4f/geocode/" + lon + "," + lat + ".json";
		var reverseGeocode = new XMLHttpRequest();
                reverseGeocode.open('GET',reverseGeocodeURL,false);
                reverseGeocode.send();
		// need to use the 2-letter abbrev to match up with kml
		var reverseGeocodeParsed = JSON.parse(reverseGeocode.responseText);
		var stateLongName = reverseGeocodeParsed.results[0][2].name; // Wisconsin
		var stateAbbrev = statesToAbbreviations[stateLongName];      // WI

		// get weather data for current location and time	
		// weather data is courtesy http://www.worldweatheronline.com free api
		// via mashery.com
		const weatherDataElement = 0;		// data.current_condition[weatherDataElement]
		const weatherDisplaySize = 10;		// size of weatherDisplay array	
		var localWeatherURL="https://www.airmanopus.net/cgi-bin/worldweatheronline.cgi?lat=" + lat + "&lon=" + lon;
		var localWeatherGet = new XMLHttpRequest();
		localWeatherGet.open('GET',localWeatherURL,false);
		localWeatherGet.send();
		var weatherConditions = JSON.parse(localWeatherGet.responseText);

		// not completely decided which fields are going to be included so these may change
		var weatherDesc = weatherConditions.data.current_condition[weatherDataElement].weatherDesc[0].value;
		var temp_F = weatherConditions.data.current_condition[weatherDataElement].temp_F;
		var visibility = weatherConditions.data.current_condition[weatherDataElement].visibility;
		var humidity = weatherConditions.data.current_condition[weatherDataElement].humidity;   
		var precipMM = weatherConditions.data.current_condition[weatherDataElement].precipMM;
		var windSpeed = weatherConditions.data.weather[weatherDataElement].windspeedMiles;
		var windDir = weatherConditions.data.weather[weatherDataElement].winddirection;
		var obsTime = weatherConditions.data.current_condition[weatherDataElement].observation_time;
		var city = weatherConditions.data.nearest_area[weatherDataElement].areaName[0].value;
		var state = weatherConditions.data.nearest_area[weatherDataElement].region[0].value;
		
		var weatherIconURL = weatherConditions.data.weather[weatherDataElement].weatherIconURL;
		var weatherInfoURL = weatherConditions.data.weather[weatherDataElement].weatherURL;

		// assemble the fields to output into one array, then loop once to display
		// TODO when we refresh after changing location we need to refresh this information as well
		weatherDisplay = new Array(weatherDisplaySize);
		weatherDisplay[0] = city + ", " + state;
		weatherDisplay[1] = lat + "," + lon;
		weatherDisplay[2] = weatherDesc + " and " + temp_F + "\xB0" + "F";
		weatherDisplay[3] = "Humidity " + humidity + "% Visibility " + visibility + " mi";
		weatherDisplay[4] = "Wind " + windDir + " at " + windSpeed + "mph";
		weatherDisplay[5] =(precipMM>0.0)?"Precip "+ precipMM:"Precip: none";
		weatherDisplay[6] = "Observed at " + obsTime + " UTC";
		for (var i = 0; i <= 6; i++)
		{
			weather.innerHTML += weatherDisplay[i] + "<br>";
		} 
		// end worldweatheronline.com 


		// now check on airport delays
	
		var airportListURL="https://www.airmanopus.net/cgi-bin/airportlist.csv";
		var airportListGet = new XMLHttpRequest();
		airportListGet.open('GET',airportListURL,false);
		airportListGet.send();

		var airportListStatus = (airportListGet.statusText);
		var airportList = (airportListGet.responseText);

		var airports = CSVToArray(airportList);

		const numAirports = 533; 			
		var airportDelayString = ""; // will be the contents of the airports div

		const viewportDistance = 75;	// only process airports within this many miles
		const pi = 3.14159265359;	// pi
		const R = 3959; 		// approximate radius of earth in miles
		airportDisplay = new Array(3);
		
		// we need to check all of the airports to see if they are within viewportDistance of us
		for (var j = 0; j < numAirports; j++) {
			var iataIdentifier = airports[j][0];			// 3 letter iata identifier
	 		var myLat = lat;					// my latitude
			var myLon = lon;					// my longitude
			var airportLat = airports[j][1];			// airport latitude
			var airportLon	= airports[j][2];			// airport longitude
			//var airportName = airports[j][5];

			// how far away are we from the airport
			var dLat = ((airportLat-myLat) * (pi/180));
			var dLon = ((airportLon-myLon) * (pi/180));
			var myLat = (lat * (pi/180));
			var airportLat = (airportLat * (pi/180));

			var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
				Math.sin(dLon/2) * Math.sin(dLon/2) * Math.cos(myLat) * Math.cos(airportLat); 
			var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
			var distance = R * c;					// miles
				
			// if we are within viewportDistance look up the airport status 
			 if ( distance <= viewportDistance ) 
				{
					var airportStatusURL="https://www.airmanopus.net/cgi-bin/airports.cgi?iata=" + iataIdentifier;
					var airportStatusGet = new XMLHttpRequest();
					airportStatusGet.open('GET',airportStatusURL,false);
					airportStatusGet.send();
					var airportStatusResponse = airportStatusGet.responseText;
							
					// if we see a less than chr we didnt get a json response
					// so ignore that airport even though it is within range
					if ( airportStatusResponse.charAt(0) != "<" )
					{
						var airportStatus = JSON.parse(airportStatusGet.responseText);

						var airportIATA = airportStatus.IATA;
						var airportName = airportStatus.name;
						var delayStatus = airportStatus.delay;
						var airportDelayReason = airportStatus.status.reason;
						var airportClosureBegin = airportStatus.status.closureBegin;
						var airportClosureEnd = airportStatus.status.closureEnd;
						var airportMinDelay = airportStatus.status.MinDelay;
						var airportMaxDelay = airportStatus.status.MaxDelay;
						var airportAvgDelay = airportStatus.status.AvgDelay;

						// fill airportDisplay
						
						// compulsories
						airportDisplay[0] = airportName + "(" + airportIATA + ")";
						airportDisplay[1] = airportDelayReason;

						// always display closure info if airport is closed 
						if ( airportClosureBegin != "")
						{
							airportDisplay[2] = "Closure from " + airportClosureBegin + " to " + airportClosureEnd;
						
						} 
	
						// only display delay details if there is actually a delay
						if  ( delayStatus != "false" ) {
							airportDisplay[3] = "Min " + airportMinDelay + " Max " + airportMaxDelay + " Avg " + airportAvgDelay;
						}
						for (var i = 0; i <= 3; i++)
						{
						airports.innerHTML += airportDisplay[i] + "<br>"; 
						}

					}
				}

			} 
		});
	}
}
</script>
<style>
html, body, #map {
	width: 100%;
	height: 85%;
	padding: 0;
	margin: 0;
}
</style>
</head>
<body onload="initialize()">

<div id="map"></div>
<div id="weather"></div>
<div id="airports"></div>
</html>


